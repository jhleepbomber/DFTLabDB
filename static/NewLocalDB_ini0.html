<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Materials database</title>
        <!-- Favicon-->
      
        <!-- Bootstrap icons-->
        <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" /> -->
        <!-- Core theme CSS (includes Bootstrap)-->

         <!-- <link href="css/styles.css" rel="stylesheet" /> -->
          <link href="/static/css/Bootstrap513/bootstrap.min.css" rel="stylesheet" />  
		  <link href="/static/css/styles.css" rel="stylesheet" /> 
		  		  

        <!-- <script type="text/javascript" src="js/bootstrap.bundle.min.js"></script> -->
         <script type="text/javascript" src="{{ url_for('static', filename='js/BootStrap513/bootstrap.bundle.min.js') }}"></script> 

         

		 <style>
		 .Block_tooltip {
			position: relative;
			display: inline-block;
			border-bottom: 1px black;
		  }
		  
		  .Block_tooltip .Block_tooltiptext {
			visibility: hidden;
			width: auto;
			background-color: #ddd;
			color: #000;
			text-align: center;
			border-radius: 6px;
			padding: 5px 0;
			position: absolute;
			z-index: 1;
			top: 150%;
			left: 50%;
			margin-left: -90px;
			opacity: 0;
			transition: opacity 0.3s;
			white-space:nowrap;
		  }
		  
		  .Block_tooltip .Block_tooltiptext::after {
			content: "";
			position: absolute;
			bottom: 100%;
			left: 50%;
			margin-left: -5px;
			border-width: 5px;
			border-style: solid;
			border-color: #666 transparent transparent transparent;
		  }
		  
		  .Block_tooltip:hover .Block_tooltiptext {
			visibility: visible;
			opacity: 1;
		  }

</style>

<script type="text/javascript" src="/static/js/three/libs/Three_R86.js"></script>
<script type="text/javascript" src="/static/js/three/libs/ThreeBSP.js"></script>
<script type="text/javascript" src="/static/js/three/libs/TrackballControls_R68.js"></script> 
<script type="text/javascript" src="/static/js/three/font/helvetiker_bold.typeface.jss"></script>

<script type="text/javascript" src="static/js/MarchingCubes/MarchingCubes.js"></script>
<script type="text/javascript" src='static/js/Plotly/plotly-2.3.0.min.js'></script>

<script>

var N_DBfield;
var N_DBdata;
var arr_key;

var LatticeVector = new Array(3);
for(var i=0; i<3; i++) LatticeVector[i] = new THREE.Vector3( 0, 0, 0 );

var Max_N_Species =50;
var Species_DelOrder = new Array(Max_N_Species);
var Species_Order = new Array(Max_N_Species);
var Species_Number= new Array(Max_N_Species);
var Species_Name = new Array(Max_N_Species);

var P_Atoms ;
var ID_Atom ;

var P_Atoms_out ;
var ID_Atom_out ;

var SuperCell = new Array(3);
SuperCell[0]=1; 
SuperCell[1]=1; 
SuperCell[2]=1;
var N_Range=150;

var N_sel_DBfield = 5;

var nonz_i = new Array();

var Dxx, Dyy, Dzz;
var dx, dy ,dz;

var dx_g, dy_g, dz_g;

var Real_N_Atoms ;
var N_Atoms=0;
var N_Species, T_N_Species ;
var Mx_Species_Number;

var N_nod;

var Link_color=0xddccff;

var Rhos = {};

var exe_mod;

var scale_fac=1.0 ;
var R_Bohr = 0.53;
var Lattice_C ;
var scene_width = 500;
var scene_height= 500;

var mouse = {  x: 0,  y: 0}, INTERSECTED;


var camera;// = new THREE.PerspectiveCamera(45, scene_width / scene_height, 0.01, 10000);
var scene = new THREE.Scene();
var renderer = new THREE.WebGLRenderer();

var raycaster = new THREE.Raycaster();

var Atoms = new THREE.Object3D();
var Link_Group = new THREE.Object3D();
var aBoxLine = new THREE.Object3D();



var BoxLineGroup = new THREE.Object3D();

var BoxGroup = new THREE.Object3D();

var BoxGroup_out = new THREE.Object3D();


var ambientLight = new THREE.AmbientLight(0x1c1c1c); scene.add(ambientLight);

var directionalLight = new THREE.DirectionalLight(0xffffff,1); scene.add(directionalLight);

var directionalLight2 = new THREE.DirectionalLight(0xffffff,1); scene.add(directionalLight2);
var V_mx=-1e1000, V_mn=1e1000;
var xmx_out=-1e1000, ymx_out=-1e1000, zmx_out=-1e1000;
var xmn_out= 1e1000, ymn_out= 1e1000, zmn_out= 1e1000;

var canvas ;
var eqv_surf_f;
var eqv_surf_b;

var plateViewers = new Array(3);
var arrow_plates = new Array(3);
var N_t=1 ;

var camera_Vscale=1;

var N_links;
var Links= new Array(1) ;

var atom_Geo = new Array();
var atom_Mat = new Array();
var atom = new Array();
var Link = new Array();

var ON_save_P=0;
var ON_save_R=0;

var Vertices = {}; 
var ang = Math.PI*15/180;
var t_i=0;

var F_m_graph = false;

var cell_color = "#fdfdfd";

var cell_color_selback = "#666666";

var header_color_back = "#e0e0e0";

var Atom_Name=["Removed",
		       "H" , "He",
		       "Li","Be", "B" ,"C" ,"N" ,"O" ,"F" ,"Ne",
		       "Na","Mg", "Al","Si","P" ,"S" ,"Cl","Ar",
		       "K" ,"Ca","Sc","Ti","V" ,"Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr",
			   "Rb","Sr","Y" ,"Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I" ,"Xe",
			   "Cs","Ba",
			             "La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu",
			                  "Hf","Ta","W" ,"Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn",
		       "Fr","Ra",
			             "Ac","Th","Pa","U" ,"Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr",
			                  "Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn","Nh","Fl","Mc","Lv","Ts","Og"  ];

var Atom_color = [ '000000',
				   'ff4444', '777777',
				   'ff4422','dd2200', 'ffff44','44ff44','ff8800','4444dd','4444ff','666666',
				   'ff2244','dd3300', 'ffff22','22ff22','ffcc00','4400dd','2222ff','555555',
				   'ff2222','dd3300','aa6600','ff9900','ffcc00','ff0000','ff0000','ff0000','ffcc00','ff0000','ff0000','ff0000','ffff00','00ff00','ffcc00','0044dd','0000ff','444444',
				   'ff0000','dd3300','aa6600','ff9900','ffcc00','ff0000','ff0000','ff0000','ffcc00','ff0000','ff0000','ff0000','dddd00','00dd00','ffcc00','2222dd','0000dd','333333',
				   'dd0000','dd0000',
									 'ff0000','dd3300','aa6600','ff9900','ffcc00','ff0000','ff0000','ff0000','ffcc00','ff0000','ff0000','ff0000', 'ff6600','ff9900','ffcc00',
											  'ff0000','ff3300','ff6600','ff9900','ffcc00','ff0000','ff0000','ff0000','ffcc00','bbbb00','00bb00','ff0000', '2200dd','0000bb','222222',
				   'bb0000','dd0000',
									 'ff0000','dd3300','aa6600','ff9900','ffcc00','ff0000','ff0000','ff0000','ffcc00','ff0000','ff0000','ff0000', 'ff6600','ff9900','ffcc00',
											  'ff0000','ff3300','ff6600','ff9900','ffcc00','ff0000','ff0000','ff0000','ffcc00','999900','009900','ff0000', '0022dd','000099','111111'
				   ];


var Atom_R = [ ];

var sort_state;

for (var i=1; i<=118; i++) Atom_R[i]=i*0.005+0.2;

var Is_N_spe = new Array(119);
for ( var i=0; i<119; i++ ) Is_N_spe[i]=0;


        var INCAR_open = new Array();
        for(var i=0; i<=10; i++) INCAR_open[i] = false;

      
       function change_bullet(car_id)
       {
          var V_i = parseInt(car_id.split('_')[1]);
          INCAR_open[V_i] = !INCAR_open[V_i];   

          if (INCAR_open[V_i]==true) { document.getElementById("inputText_"+String(V_i)).style.display= ""; }
          else                       { document.getElementById("inputText_"+String(V_i)).style.display= "none"; }
       }

       function delete_td()
       {
          document.getElementById("r1").style.display = "none"; 
       }
     


       function openTextFile(text_id) {
        var input = document.createElement("input");
        input.type = "file";
		input.multiple = true;
        //input.accept = "text/plain"; // 확장자가 xxx, yyy 일때, ".xxx, .yyy"
        input.onchange = function (event) {
		
			document.getElementById(text_id).value="";
			for (var i=0; i<event.target.files.length; i++)
			{
				processFile(event.target.files[i], text_id, event.target.files[i].name);
			}
        };
        input.click();
    }
    
    function processFile(file, text_id, file_name) {
       
        var reader = new FileReader();
        reader.onload = function () {           

			document.getElementById(text_id).value+= "#--------------- "+ file_name +" ---------------------------------------\n";

			var contents_dummy = reader.result.replace(/%include/gi, '#%include');
            
            document.getElementById(text_id).value+= contents_dummy;
            
            //output.innerText = reader.result;
        };
        reader.readAsText(file, /* optional */ "euc-kr");
    }

    function replace_text() {

        var textarea = document.getElementById("INCAR_text");
        var len = textarea.value.length;
        var start = textarea.selectionStart;
        var end = textarea.selectionEnd;
        var sel = textarea.value.substring(start, end);
        // This is the selected text and alert it
        
        var replace = '<b>' + sel + '</b>';
             // Here we are replacing the selected text with this one
        textarea.value =  textarea.value.substring(0,start) + replace + textarea.value.substring(end,len);
    }
   
	var DBkey_i = {}

function Initialize(Field_keys, User_List, Year_List, Journal_List, Model_List, program_List, F_mod, Dir_list)
{		

    Field_keys = "   ," + Field_keys
    arr_key    = Field_keys.split(","); // All keys for all documents


    N_DBfield  = arr_key.length;

	sort_state = new Array(N_DBfield).fill(0);	

	for(var j=1; j<N_DBfield; j++)       
    {  
		arr_key[j] = arr_key[j].trim();

		temp_key = arr_key[j]; 

		DBkey_i[temp_key] = j; 		
	
	}

	var arr_fixed_key = new Array(5);

	User_List = "   ," + User_List;
    arr_fixed_key[0] = User_List.split(","); // All keys for all documents

	Year_List = "   ," + Year_List;
    arr_fixed_key[1] = Year_List.split(","); // All keys for all documents

	Journal_List = "   ," + Journal_List;
    arr_fixed_key[2] = Journal_List.split(","); // All keys for all documents

	Model_List = "   ," + Model_List;
    arr_fixed_key[3] = Model_List.split(","); // All keys for all documents

	program_List = "   ," + program_List;
    arr_fixed_key[4] = program_List.split(","); // All keys for all documents


    var Field_tr1_center = document.getElementById('Field_tr1_center');
    var Field_tr2_center = document.getElementById('Field_tr2_center');

	var Field_tr1_right = document.getElementById('Field_tr1_right');
    var Field_tr2_right = document.getElementById('Field_tr2_right');

    Field_tr1_center.innerHTML = "";
    Field_tr2_center.innerHTML = "";

	Field_tr1_right.innerHTML = "";
    Field_tr2_right.innerHTML = "";

	var fixed_field    = ["User", "Year", "Journal", "Model", "program"];	

	for(var i=0; i<fixed_field.length; i++)
    {
		var td1 = document.createElement('td');
		var td2 = document.createElement('td');	

		td1.setAttribute("id", "id_field"+String(i));	
		td1.setAttribute("style", "font-weight: bold;");         		

		var cellText = document.createTextNode(fixed_field[i]);
		td1.appendChild(cellText);

		Field_tr1_center.append(td1);

		var select0 = document.createElement('select');	
		
		select0.setAttribute("id", "id_field_text"+String(i));			
		select0.setAttribute("style", "width: 80px");         
		select0.setAttribute("onchange", "write_hidden()");         
	
		for(j=0; j<arr_fixed_key[i].length; j++)
		{
			

			var option0 = document.createElement('option');
			var cellText = document.createTextNode(arr_fixed_key[i][j]);
			option0.appendChild(cellText);
			select0.appendChild(option0);
		}		
		td2.appendChild(select0);
		Field_tr2_center.append(td2);
	}

    for(var i=fixed_field.length; i<fixed_field.length+N_sel_DBfield; i++)
    {
		var td1 = document.createElement('td');
		var td2 = document.createElement('td');
		
		var select0 = document.createElement('select');
	
		select0.setAttribute("id", "id_field"+String(i));	
		select0.setAttribute("style", "width: 80px");         
		select0.setAttribute("onchange", "write_hidden()");         
		
		for(j=fixed_field.length+1; j<N_DBfield; j++)
		{

			var option0  = document.createElement('option');
			if(j===fixed_field.length+1) { var cellText = document.createTextNode(""); }
			else			             { var cellText = document.createTextNode(arr_key[j]);}
			
			option0.appendChild(cellText);
			select0.appendChild(option0);
		}
		//var cellText = document.createTextNode("cell 1");
		//td1.appendChild(cellText);
		td1.appendChild(select0);
		Field_tr1_right.append(td1);
		
		var textbox = document.createElement("input");

		textbox.setAttribute("type", "text");
		textbox.setAttribute("id", "id_field_text"+String(i));	
		textbox.setAttribute("text", "");
		textbox.setAttribute("onchange", "write_hidden()");
		textbox.setAttribute("style", "width: 80px");

		td2.appendChild(textbox);
		//var cellText = document.createTextNode("cell 2");
		//td2.appendChild(cellText);

		Field_tr2_right.append(td2);

    }

	write_hidden();

	if(F_mod==0)
	{
		document.getElementById("id_updateDB_state").style.color = "#000000";
		document.getElementById("id_updateDB_state").innerHTML  = "";

		document.getElementById("id_updateDB_state2").style.color = "#000000";
		document.getElementById("id_updateDB_state2").innerHTML  = "";

		var User_Paths = document.getElementById("id_User_Paths").value;
	
		var arr_User_Paths = User_Paths.split(",");

		var N_path = arr_User_Paths.length;

		var dir_name4Down, dir_ref_UpDown ;

		var dir_name4Down_button;
		var dir_name ;	
		
		var root_i ;
		
		var p_i = 0;

		var Path_Tree = document.getElementById("id_Path_Tree"); 

		Path_Tree.innerHTML = '';

		for(var a_path of arr_User_Paths)
		{
			var arr_a_path = a_path.split("/");

			var N_a_path = arr_a_path.length;

			if (p_i === 0){ root_i = N_a_path; }

			var temp_path = a_path;

			for (var i =0; i<root_i-1; i++)
			{
				temp_path = temp_path.substring(temp_path.indexOf("/")+1) ;  		
			}
			
			dir_name   = arr_a_path[N_a_path - 1];

			dir_name4Down = "id_" + temp_path; 
			dir_name4Down_button = a_path;
			dir_ref_UpDown = "id_" + temp_path.substring(0, temp_path.lastIndexOf("/")); 

			if (p_i === 0)
			{ 
				var ul = document.createElement('ul');		
				ul.setAttribute("style", "list-style:none;");			

				Path_Tree.appendChild(ul);

				var li = document.createElement('li');			
				ul.appendChild(li);			

				var label = document.createElement('label');			
				label.innerHTML ="L";			
				label.setAttribute("onclick", "toggle_path('"+ dir_name4Down +"')");

				li.appendChild(label); 

				var button = document.createElement('button');			
				button.setAttribute("style", "background:white;font-size:5");
				button.setAttribute("id", dir_name4Down_button);					
				button.setAttribute("onclick", "toggle_path_color(this)");
				button.innerHTML= dir_name;
				li.appendChild(button); 

				var ul = document.createElement('ul');	
				ul.setAttribute("style", "list-style:none; display: none");			
				ul.setAttribute("id", dir_name4Down);			
				li.appendChild(ul); 

			}
			else
			{


				var ul = document.getElementById(dir_ref_UpDown);			

				var li = document.createElement('li');			
				ul.appendChild(li);

				var label = document.createElement('label');			
				label.innerHTML ="L";
				label.setAttribute("onclick", "toggle_path('"+ dir_name4Down +"')");
				li.appendChild(label); 

				var button = document.createElement('button');			
				button.setAttribute("style", "background:white;font-size:5");
				button.setAttribute("id", dir_name4Down_button);					
				button.setAttribute("onclick", "toggle_path_color(this)");
				button.innerHTML= dir_name;
				li.appendChild(button); 

				var ul = document.createElement('ul');			
				ul.setAttribute("style", "list-style:none; display: none");			
				ul.setAttribute("id", dir_name4Down);			
				li.appendChild(ul); 
				

			}		

			p_i++ ;
		}


	}

	make_DirList(Dir_list);

	


	
	
	

}


function toggle_path(down_path)
{

	if (document.getElementById(down_path).style.display ==="none")
	{
		document.getElementById(down_path).style.display="" ;
	}
	else
	{
		document.getElementById(down_path).style.display ="none";
	}

	

}

var old_sel_obj="";
function toggle_path_color(sel_obj)
{
	if (sel_obj.style.background ==="white")
	{
		sel_obj.style.background ="#555555" ;
		sel_obj.style.color      ="white" ;

		if(old_sel_obj !="")
		{
			old_sel_obj.style.background ="white" ;
			old_sel_obj.style.color      ="#333333" ;
		}

		old_sel_obj = sel_obj;
		

		document.getElementById('id_hidden_selpath').value = sel_obj.id;

	}
	else
	{
		sel_obj.style.background ="white" ;
		sel_obj.style.color      ="#555555" ;

		old_sel_obj ="";

		document.getElementById('id_hidden_selpath').value = "";

	}



	

}

var old_col = -1;

function sort_column(col)
{	

	if(col != old_col) sort_state[old_col] = 0;
	//sort_state[old_col] = 0;

	if (sort_state[col] == 0)
	{
		var DBtable, rows ;
		DBtable = document.getElementById("id_DBtable");
		rows = DBtable.rows;

		sort_state[col] = 1;
		old_col = col;
	
		var arr     = [];
		var index   = [];
		var index_p = [];

		for(var i=0; i<N_DBdata; i++)
		{
			var val = Number(rows[i+1].cells[col-1].innerHTML);

			
			arr.push(val);
			index.push(i);
			
		}

		

		Qsort(arr, N_DBdata, 0, N_DBdata-1, index);

		

		for(var i=0; i<N_DBdata; i++)
		{
			index_p[i] = index.indexOf(i);
		}

		for(var i=0; i<N_DBdata-1; i++)
		{
			rows[1].parentNode.insertBefore(rows[index[i]+1], rows[i+1]);

			var index_i = index[i];

			for(var j = i; j< index_i; j++)
			{
				index[index_p[j]] += 1;		
			}
			
			const item = index_p.splice(index_i, 1); // ['banana']
			index_p.splice(i, 0, item[0]);
		
		}

	}
	else if (sort_state[col] == 1)
	{		

		var DBtable, rows ;
		DBtable = document.getElementById("id_DBtable");
		rows = DBtable.rows;

		for(var i=0; i<N_DBdata-1; i++)
		{
			rows[1].parentNode.insertBefore(rows[N_DBdata], rows[i+1]);	
		}
	}

	if(F_m_graph)
	{
		Draw_m_graph();
	}

}


var g_xyz, g_col;

var g_col_xyz = [-1,-1,-1];

var old_xyz, old_g_col;

var g_backcolor = "#000099";

function sel_xyz(temp_col, xyz, xyz_1, xyz_2)
{
	g_xyz = xyz      ;
	g_col = temp_col ;

	var id_temp = "id_"+ String(g_col) + "_" + String(g_xyz) ;

	if (g_col===old_g_col && g_xyz===old_xyz)
	{		

		if (document.getElementById(id_temp).style.color == "rgb(255, 255, 255)")
		{			
			document.getElementById(id_temp).style.color = "#000000";			
			document.getElementById(id_temp).style.backgroundColor = header_color_back;
			sel_column(0);
			g_col_xyz[g_xyz] = -1;

		}
		else
		{			
			document.getElementById(id_temp).style.color = "#ffffff";
			document.getElementById(id_temp).style.backgroundColor = g_backcolor;			
			sel_column(1);
			g_col_xyz[g_xyz] = g_col;
			
		}

		return;
	}

	g_col_xyz[g_xyz] = g_col;
	
	document.getElementById(id_temp).style.backgroundColor = g_backcolor;
	document.getElementById(id_temp).style.color = "#ffffff";

	

	id_temp = "id_"+ String(g_col) + "_" + String(xyz_1) ;

	document.getElementById(id_temp).style.backgroundColor = header_color_back;
	document.getElementById(id_temp).style.color = g_backcolor;

	id_temp = "id_"+ String(g_col) + "_" + String(xyz_2) ;

	document.getElementById(id_temp).style.backgroundColor = header_color_back;
	document.getElementById(id_temp).style.color = g_backcolor;

	old_xyz = xyz;

	old_g_col = g_col;

	sel_column(1);
}


var g_col_backcolor_x = "#000099";

var g_selcolor = ["#ffeeee","#eeffee","#eeeeff"];

function sel_column(mod)
{


	for(var i=0; i<N_DBdata; i++)
    {

		var id_temp = "id_DBtable_" + String(i) + "_" + String(g_col);

		var td0 = document.getElementById(id_temp);

		if (mod ==1) td0.style.background = g_selcolor[g_xyz];
		if (mod ==0) td0.style.background = "#ffffff";

	}

}

function make_DirList(Dir_list)
{
	

	arr_Dir_list = Dir_list.split(",");
	
	var dir_list_table = document.getElementById('id_dir_list');

	dir_list_table.innerHTML ="";

	for (adir of arr_Dir_list)
	{
		var tr0 = document.createElement('tr');
		tr0.setAttribute("style", "border: 1px solid black; border-collapse: collapse; ");
		//tr0.setAttribute("bgcolor", header_color_back);
			
		dir_list_table.appendChild(tr0);

		var td0 = document.createElement('td');            						
            tr0.appendChild(td0);
            td0.setAttribute("style", "border: 1px solid black; border-collapse: collapse;  white-space:nowrap;");     


		var cellText = document.createTextNode(adir);            
          	td0.appendChild(cellText);			
			

	}




}

function make_DBtable(N_db)
{

	N_DBdata = Number(N_db);

    var db_result = DB_search.document.getElementById("id_db_result").value; // start from id --> 1 is right

    var arr_db_result = db_result.split("@@@");

    var wrapper_DBtable = document.getElementById('id_Wrapper_DBtable');

    wrapper_DBtable.innerHTML = "";
    var DBtable = document.createElement('table');

    DBtable.setAttribute("id", "id_DBtable");
	DBtable.setAttribute("style", "border: 1px solid black; border-collapse: collapse; font-size:12px;");

    wrapper_DBtable.appendChild(DBtable);
                
    // table head ---------------------------------------------------------------------------------
    var tr0 = document.createElement('tr');
    tr0.setAttribute("style", "border: 1px solid black; border-collapse: collapse; ");
    tr0.setAttribute("bgcolor", header_color_back);
	    
    DBtable.appendChild(tr0);

    // html head
	// blank :0, id_ :1, start from 2  ----------------------------------------------------------

	var j=1;

	for (var temp_key of arr_key) 
    { 
		
		if (temp_key == "   ") continue;
		var th0 = document.createElement('th');
		tr0.appendChild(th0);
		//th0.setAttribute("id", "id_DBth_" + String(j));
		th0.setAttribute("style", "border: 1px solid black; border-collapse: collapse; white-space:nowrap; position: sticky; top: 0; background-color: " +header_color_back+";");        
		
		

		temp_key = "<div id='id_DBth_"+ String(j) +"' onclick=sort_column(" + String(j) + ")>" + temp_key + "</div> <label id ='id_"+ String(j) +"_0' onclick='sel_xyz("+ String(j) +",0,1,2)'> x </label> <label id ='id_"+ String(j) +"_1' onclick='sel_xyz("+ String(j) +",1,0,2)'> y </label> <label id ='id_"+ String(j) +"_2' onclick='sel_xyz("+ String(j) +",2,0,1)'> z </label>"

		j++;

		//temp_key = temp_key + "<br> <button>x</button> <button>y</button> <button>z</button>";

		th0.innerHTML = temp_key;

		    		   
    }
	
    // table body -----------------------------------------------------------------------------
    for(var i=0; i<N_DBdata; i++)
    {
                
		var cellText;
		var db_rows = arr_db_result[i].split(",");	   
	    var dic_row = {};

	   for (var temp_key of db_rows) 
	   { 
			
		    if (temp_key == "   ") continue;			
			
		    var temp_arr = temp_key.split(":");			

			temp_arr[1] = temp_arr[1].replace(/"+/g, "");

		    dic_row[temp_arr[0].trim()] = temp_arr[1].trim();
			
	   }

       var tr0 = document.createElement('tr');
       tr0.setAttribute("id", "id_DBtr_" + String(i));
       tr0.setAttribute("style", "border: 1px solid black; border-collapse: collapse; ");
       tr0.setAttribute("onclick", "select_item("+String(i)+ ",\"" + dic_row["User"] + "\",\"" + dic_row["DataSN"]+"\",\"" + dic_row["Year"]+"\",\"" + dic_row["Journal"]+"\",\"" + dic_row["Model"]+"\",\"" + dic_row["program"]+"\",\"" + dic_row["Comment"]+"\",\"" + dic_row["Arg_out"]+"\")");
       tr0.setAttribute("bgcolor", cell_color);
           
       DBtable.appendChild(tr0);

	   var j=1;

	   for (var temp_key of arr_key) 
	   { 
			if (temp_key == "   ") continue;
			
			var td0 = document.createElement('td');            
            td0.setAttribute("id", "id_DBtable_" + String(i) + "_" + String(j));  j++;
						
            tr0.appendChild(td0);
            td0.setAttribute("style", "border: 1px solid black; border-collapse: collapse;  white-space:nowrap;");     

			if (dic_row[temp_key.trim()]==undefined ) 
			{
				var cellText = document.createTextNode("");            
            	td0.appendChild(cellText);			
				continue;

			}
			
			var arr_dic_row = dic_row[temp_key.trim()].split("*@@*");

			if (arr_dic_row[0].trim() =="BlockInfo")
			{
			
				var Tooltip_div = document.createElement('div');            
				Tooltip_div.classList.add('Block_tooltip');			
				var cellText = document.createTextNode("BlockInfo");            
				Tooltip_div.appendChild(cellText);
					
				td0.appendChild(Tooltip_div);

				var Tooltip_span = document.createElement('span');            
				Tooltip_span.classList.add('Block_tooltiptext');
				//var cellText = document.createTextNode(arr_dic_row[1]);

				//Tooltip_span.innerHTML = arr_dic_row[1];

				Tooltip_span.innerHTML = "Under construction";

				Tooltip_div.appendChild(Tooltip_span);

			}
			else
			{
				var cellText = document.createTextNode(dic_row[temp_key]);            
            	td0.appendChild(cellText);
			}    
			
		

			
		    		   
	   }
        
    }

}

var sel_item, old_sel_item; 

var sel_username, sel_DataSN, sel_Year , sel_Journal, sel_Model, sel_program, sel_Comment;

function select_item(sel_i, username, DataSN, Year, Journal, Model, program, Comment, Arg_out)
{
    
    var con_string ;
    var N_field = 7 ;

	clear_contents();

    sel_item = Number(sel_i);			

    //-- restore old select item ---------------

    con_string = "id_DBtr_" + String(old_sel_item);

    var IsOld = !!document.getElementById(con_string);
    
    if (IsOld==true) 
    {
        document.getElementById(con_string).style.background = cell_color;
        document.getElementById(con_string).style.color = '#000000';
    }

    

    //-- new select item ---------------

    con_string = "id_DBtr_" + String(sel_item);

    document.getElementById(con_string).style.background = cell_color_selback;
    document.getElementById(con_string).style.color = '#ffffff';

    old_sel_item = sel_item;
    //---------------- file list load ------------------------------------

    sel_username = username.trim();
    sel_DataSN = DataSN.trim();
	sel_Year = Year;
	sel_Journal = Journal;
	sel_Model = Model;
	sel_program = program;
	sel_Comment = Comment;

	var Newpath = username + '__'+ DataSN + '__'+ Year + '__'+ Journal + '__'+ Model + '__'+ program + '__'+ Comment;

	document.getElementById("id_hidden_SelNewPath").value = Newpath;
	
	var download_link = '/static/Downloads/' + username + '/' + program + '/' + Newpath + '.zip';

	//document.getElementById('id_download_result').href = download_link;	

	document.getElementById('id_hidden_Download_link').value = download_link;	

	
    var data_file='/static/DB_Group/' + username + '/' + program + '/' + Newpath +'/DB_info.inf';
    
    var data_string;

    const request = new XMLHttpRequest();
    const url = data_file;

    request.open('GET', url, true);
    request.onload = function () 
    {  
        //data_string = request.responseText;
    };
    request.send();
    
    request.onreadystatechange = function()
    { 
        if(request.readyState === request.DONE)
        { 
            if(request.status === 200 || request.status === 201)
            { 
                
                data_string = request.responseText;
                


                var lines = data_string.split('\n');
                
                for ( var index=0; index<lines.length; index++ ) {
                    
                    var line = lines[index].trim();		

                    if ( !line ) continue;		

                    if ( line[0] === '@') {
                        var line = line.replace('@', '');
                        var keyVal = line.split(' ');
                        var start = index+1;
                        
                        var end_i = start + Number(keyVal[1]);                        
                        index = end_i-1;
                        if(keyVal[0].trim()=='File_list') { parseFileList( lines.slice(start, end_i));  break;	}
                        else							{ alert( 'No file list ---'); }
                    }
                    
                }

                //document.getElementById('id_hidden_info').value = dir_path;
                document.getElementById('id_contents_text_2').value = '';

            }  
            else
            { 
                console.log('실패'); 
            } 
        } 
    };

	show_Graphs();
	show_Arg(Arg_out);

    
            
}

function parseFileList ( dataLines ) 
{    

    var File_List = document.getElementById("id_File_list");

    File_List.options.length=0; 

    for (var a_data in dataLines)
    {        
        
        var objOption = document.createElement("option");       
        objOption.text = dataLines[a_data];
        objOption.value = dataLines[a_data];				
        File_List.options.add(objOption);

    }


}

function clear_contents()
{

    document.getElementById('id_contents_text_1').innerHTML = "";
    document.getElementById("id_contents_graph2D_1").innerHTML = "";
    document.getElementById("id_contents_graph3D_1").innerHTML = "";

	document.getElementById('id_contents_text_2').innerHTML = "";
    document.getElementById("id_contents_graph2D_2").innerHTML = "";
    document.getElementById("id_contents_graph3D_2").innerHTML = "";

	document.getElementById('id_contents_text_3').innerHTML = "";
    document.getElementById("id_contents_graph2D_3").innerHTML = "";
    document.getElementById("id_contents_graph3D_3").innerHTML = "";

    document.getElementById('id_contents_text_4').innerHTML = "";
    document.getElementById("id_contents_graph2D_4").innerHTML = "";
    document.getElementById("id_contents_graph3D_4").innerHTML = "";


}

function show_Arg(Argout_file)
{
	// show atomic structure------------
	var data_file='/static/DB_Group/' + sel_username + "/" + sel_program + "/" + sel_username + '__' + sel_DataSN + '__' + sel_Year + '__' + sel_Journal + '__' + sel_Model + '__' + sel_program + '__' + sel_Comment +'/' + Argout_file;
        
	var data_string;

	const request = new XMLHttpRequest();
	const url = data_file;

	request.open('GET', url, true);
	request.onload = function () {  };
	request.send();

	request.onreadystatechange = function()
	{ 
		if(request.readyState === request.DONE)
		{ 
			if(request.status === 200 || request.status === 201)
			{   				
				data_string = request.responseText;
				
				document.getElementById("id_contents_text_2").style.display= "";
				document.getElementById("id_contents_graph2D_2").style.display= "none";
				document.getElementById("id_contents_graph3D_2").style.display= "none";	

				document.getElementById("id_contents_text_2").value = data_string;
				
				

				

			}  
			else
			{ 
				document.getElementById("id_contents_text_2").style.display= "";
				document.getElementById("id_contents_graph2D_2").style.display= "none";
				document.getElementById("id_contents_graph3D_2").style.display= "none";

				document.getElementById("id_contents_text_2").value = "No argout file";

				
			} 
		} 
	};
	

}

function show_Graphs()
{

	// show atomic structure------------
	var data_file='/static/DB_Group/' + sel_username + "/" + sel_program + "/" + sel_username + '__' + sel_DataSN + '__' + sel_Year + '__' + sel_Journal + '__' + sel_Model + '__' + sel_program + '__' + sel_Comment +'/Structure_V_R.js3D';
        
	var data_string;

	const request = new XMLHttpRequest();
	const url = data_file;

	request.open('GET', url, true);
	request.onload = function () {  };
	request.send();

	request.onreadystatechange = function()
	{ 
		if(request.readyState === request.DONE)
		{ 
			if(request.status === 200 || request.status === 201)
			{   				
				data_string = request.responseText;

				
				
				document.getElementById("id_contents_text_3").style.display= "none";
				document.getElementById("id_contents_graph2D_3").style.display= "none";
				document.getElementById("id_contents_graph3D_3").style.display= "";				

				load_output_data( data_string, sel_program );

			
				
				

			}  
			else
			{ 
				document.getElementById("id_contents_text_3").style.display= "";
				document.getElementById("id_contents_graph2D_3").style.display= "none";
				document.getElementById("id_contents_graph3D_3").style.display= "none";

				document.getElementById("id_contents_text_2").value = "No atomic info";

				
			} 
		} 
	};

		// show ondD ------------
		var data_file2 = '/static/DB_Group/' + sel_username + "/" + sel_program + "/" + sel_username + '__' + sel_DataSN + '__' + sel_Year + '__' + sel_Journal + '__' + sel_Model + '__' + sel_program + '__' + sel_Comment +'/Bands.oneD';
    	var data_string2;
	
		const request2 = new XMLHttpRequest();
		const url2 = data_file2;
	
		request2.open('GET', url2, true);
		request2.onload = function () {  };
		request2.send();
	
		request2.onreadystatechange = function()
		{ 
			if(request2.readyState === request2.DONE)
			{ 
				if(request2.status === 200 || request2.status === 201)
				{   				
					data_string2 = request2.responseText;
	
					document.getElementById("id_contents_text_1").style.display= "none";
					document.getElementById("id_contents_graph2D_1").style.display= "";
					document.getElementById("id_contents_graph3D_1").style.display= "none";

					Draw_oneDplot('id_contents_graph2D_1', data_string2);
	
				}  
				else
				{ 
					document.getElementById("id_contents_text_1").style.display= "";
					document.getElementById("id_contents_graph2D_1").style.display= "none";
					document.getElementById("id_contents_graph3D_1").style.display= "none";
	
					document.getElementById("id_contents_text_1").value = "No band or DOS info";
	
					
				} 
			} 
		};
	
	

}

function show_file_contents()
{ 

    var File_list = document.getElementById("id_File_list");
    var sel_text  = File_list.options[File_list.selectedIndex].text;

    var sel_text_arr = sel_text.split(".");

    var extension = sel_text_arr[sel_text_arr.length-1]; 

    var Not_txt = ["gz", "tar", "DM", "HSX", "VT", "VH", "RHO", "WFSX", "TSHS"]

    for ( var ntxt of Not_txt )
    {
        
        if (extension==ntxt)
        {
            //var alarm_string = "This is ";
            //document.getElementById('id_contents_text_2').value = alarm_string + ntxt + " file."; 
			document.getElementById('id_contents_text_2').value = "Not text file"; 


        
            return;
        }

   }
            
    var data_file='/static/DB_Group/' + sel_username + "/" + sel_program + "/" + sel_username + '__' + sel_DataSN + '__' + sel_Year + '__' + sel_Journal + '__' + sel_Model + '__' + sel_program + '__' + sel_Comment + '/' + sel_text;
        
    var data_string;

    const request = new XMLHttpRequest();
    const url = data_file;

    request.open('GET', url, true);
    request.onload = function () {  };
    request.send();

    request.onreadystatechange = function()
    { 
        if(request.readyState === request.DONE)
        { 
            if(request.status === 200 || request.status === 201)
            {                   
                data_string = request.responseText;


                document.getElementById("id_contents_text_2").style.display= "";
                document.getElementById("id_contents_graph2D_2").style.display= "none";
                document.getElementById("id_contents_graph3D_2").style.display= "none";

                document.getElementById('id_contents_text_2').value = data_string;


            }  
            else
            { 
				document.getElementById("id_contents_text_2").style.display= "";
                document.getElementById("id_contents_graph2D_2").style.display= "none";
                document.getElementById("id_contents_graph3D_2").style.display= "none";

                document.getElementById('id_contents_text_2').value = "No file";


                
            } 
        } 
    };

}

function make_blank(start_i)
{
    for (var i = start_i ; i<5 ; i++)
    {
        var id_field = 'id_field' + String(i);
        var field_list = document.getElementById(id_field);
        field_list.options.length=0; 

        var objOption = document.createElement("option");          
        objOption.text = '     ';
        objOption.value = '';
        field_list.options.add(objOption);

    }

}

function write_hidden ( ) 
{

	var fixed_field = ["User", "Year", "Journal", "Model", "program"];

    var field_string ='';

	for (i=0; i<fixed_field.length;i++)
	{
		var id_field_text = 'id_field_text' + String(i);

		var field_text = document.getElementById(id_field_text);

		if (field_text.value !="")
		{

			field_string += "/@@@"+ fixed_field[i] +"@@@" + field_text.value + "@@@";

		}	
		
		
	}

    for(var i=fixed_field.length; i<fixed_field.length+N_sel_DBfield ; i++)
    {
        var id_field      = 'id_field'      + String(i);
        var id_field_text = 'id_field_text' + String(i);

        var field_list = document.getElementById(id_field);
		var field_text = document.getElementById(id_field_text);
        
		var sel_i = field_list.selectedIndex;
		if (sel_i == 0) continue;

        field_string += "/@@@" + field_list.options[sel_i].value + "@@@" + field_text.value + "@@@";


    }    

    document.getElementById("id_hidden_info_field").value = field_string;

}




var Plate = function() {
	this.mesh = function( mesh ) {
		if ( mesh ) this.Mesh = mesh;
		else return this.Mesh;
	};
	this.arrow = function( arrow ) {
		if ( arrow ) this.Arrow = arrow;
		else return this.Arrow;
	};
	this.geometry = function( geometry ) {
		if ( geometry ) this.Geometry = geometry;
		else return this.Geometry;
	};
	this.material = function( material ) {
		if ( material ) this.Material = material;
		else return this.Material;
	};
	this.vmode = function( mode ) {
		if ( arguments.length === 1 ) this.VMode = mode;
		else return this.VMode;
	};
	this.visibleArrow = function( visible ) {
		var arrow = this.arrow();
		if ( arguments.length === 1 )
		{
			arrow.visible = visible;
			if ( visible ) {
				arrow.geometry.verticesNeedUpdate = true;
			}
		}
		else return arrow.visible;
	};
};


var Canvas = function( container )
{
	var ti=0;

	// From --- middle -----

	this.plates = function( plates ) {
		if ( plates ) this.Plates = plates;
		else return this.Plates;
	};
	this.addPlate = function( id, plate ) {
		var plates = this.plates();
		if ( !plates ) {
			plates = {};
			this.plates(plates);
		}

		plates[id] = plate;
	};
	this.getPlate = function( id ) {
		var plates = this.plates();
		if ( !plates ) return false;

		return plates[id];
	};
	this.setPlateArrow = function( id, arrow ) {
		var plate = this.getPlate(id);
		plate.arrow( plate );
	};
	this.setPlateMesh = function( id, mesh ) {
		var plate = this.getPlate(id);
		plate.mesh( mesh );
	};
	this.setPlateGeometry = function( id, geometry ) {
		var plate = this.getPlate(id);

		plate.geometry( geometry );
	};
	this.setPlateMaterial = function( id, material ) {
		var plate = this.getPlate(id);

		plate.material( material );
	};
	this.getPlateArrow = function( id ) {
		var plate = this.getPlate(id);

		return plate.arrow();
	};
	this.getPlateMesh= function( id ) {
		var plate = this.getPlate(id);

		return plate.mesh();

	};
	this.getPlateGeometry = function( id ) {
		var plate = this.getPlate(id);

		return plate.geometry();
	};
	this.getPlateMaterial = function( id ) {
		var plate = this.getPlate(id);

		return plate.material();
	};

	container.appendChild( renderer.domElement );
	
};


function load_output_data( data, program ) {

	
	exe_mod=1;
	
	removeAllObjects();

	var fin_i=0;

	var lines = data.split('\n');


	ON_save_P=0;
	ON_save_R=0;

	if (program=="SIESTA" || program=="MSDFT" || program=="TranSIESTA" || program=="Transport")
	{
		for ( var index=0; index<lines.length; index++ ) 
		{

			var line = lines[index].trim();
			if ( !line ) continue;
			line=line.replace(/ +/g, " ");

			var keyVal = line.split(' ');
			
			switch( keyVal[0].trim())
			{		
			case 'LatticeConstant'           : Lattice_C               = Number(keyVal[1]);            fin_i++; break;
			case 'AtomicCoordinatesFormat'   : AtomicCoordinatesFormat = keyVal[1];                    fin_i++; break;
			case 'SaveRho'                   : if (keyVal[1]=='T' || keyVal[1]=='.true.') ON_save_R=1; fin_i++; break;
			case 'SaveElectrostaticPotential': if (keyVal[1]=='T' || keyVal[1]=='.true.') ON_save_P=1; fin_i++; break;
			}
			if (fin_i==4) break;
		}
		
				if(AtomicCoordinatesFormat==='Bohr'        || AtomicCoordinatesFormat==='NotScaledCartesianBohr') scale_fac = R_Bohr;
			else if(AtomicCoordinatesFormat==='Ang'         || AtomicCoordinatesFormat==='NotScaledCartesianAng')  scale_fac = 1.0;
			else if(AtomicCoordinatesFormat==='ScaledCartesian')                                                   scale_fac = Lattice_C;
			else if(AtomicCoordinatesFormat==='Fractional'  || AtomicCoordinatesFormat==='ScaledByLatticeVectors') scale_fac = Lattice_C;
			else scale_fac=1.0;
		
			scale_fac  = R_Bohr;
		
		//-----------------------------------------

			
		for ( var index=0; index<lines.length; index++ ) 
		{
			var line = lines[index].trim();

			

			if ( !line ) continue;

			

			if ( line[0] === '@') {
				
				var line = line.replace('@', '');
				var keyVal = line.split(' ');		
				var start = index+1;
				var end = start + Number(keyVal[1]);
				index = end-1;

                if (keyVal[0].trim()==='Rho_-1'){ON_save_R=0; }
				if (keyVal[0].trim()==='EP_-1' ){ON_save_P=0; }
				if (keyVal[0].trim()==='Bond_coor')
				{
					console.log('Bond_coor');
					console.log(line);

					N_links=Number(keyVal[1]); Define_Links();
					parseLinkCoor( lines.slice(start, end));
				}
				if (keyVal[0].trim()==='Atom_coor'){
					N_Atoms=Number(keyVal[1]);
					parseAtomCoor( lines.slice(start, end));
				}
				if (keyVal[0].trim()==='EP_data' ){parseEPData( lines.slice(start, end)); }
				if (keyVal[0].trim()==='Rho_data'){parseRhoData( lines.slice(start, end));}
				if (keyVal[0].trim()==='params'  ){parseParams( lines.slice(start, end)); }
				//else {alert( 'File type mismatch......',line );}

			}
			if ( line[0] === '%') {

				
				
				var line = line.replace('%', '');
				var keyVal = line.split(' ');

				if (keyVal[0].trim()==='block' && keyVal[1].trim()==='SuperCell')
				{
					isSuperCell=1;
					var start = index+1; var end = start + 3;
					parseSuperCell( lines.slice(start, end), 1 );
				
				}


				if (keyVal[0].trim()==='block' && keyVal[1].trim()==='LatticeVectors')
				{
				
					var start = index+1; var end = start + 3;
					parseLatticeVectors( lines.slice(start, end));
				}

			}

		}

	}

	if (program=="VASP")
	{

		scale_fac = 1;

		for ( var index=0; index<lines.length; index++ ) 
		{
			var line = lines[index].trim();
			if ( !line ) continue;
			line=line.replace(/ +/g, " ");

			var keyVal = line.split('=');

			if (keyVal[0].trim() === 'Lattice_Constant')
			{
				//Lattice_C               = Number(keyVal[1]);				
				Lattice_C               = 1.0;				
				break;
			}			
		}

		for ( var index=0; index<lines.length; index++ ) 
		{
			var line = lines[index].trim();
			if ( !line ) continue;

			if ( line[0] === '@') {
				var line = line.replace('@', '');
				var keyVal = line.split(' ');		
				var start = index+1;
				var end = start + Number(keyVal[1]);
				index = end-1;
				switch( keyVal[0].trim()) {
					case 'Rho_-1'  :  ON_save_R=0; break;
					case 'EP_-1'   :  ON_save_P=0; break;	
					case 'Atom_coor':
						N_Atoms=Number(keyVal[1]);
						parseAtomCoor( lines.slice(start, end));
						break;
					case 'Bond_coor':
						N_links=Number(keyVal[1]); Define_Links();
						parseLinkCoor( lines.slice(start, end));
						break;
					case 'EP_data' : parseEPData( lines.slice(start, end)); break;
					case 'Rho_data': parseRhoData( lines.slice(start, end)); break;
								
					case 'params'  : parseParams( lines.slice(start, end)); break;
					default: alert( 'File type mismatch......');
				}
			}
			if ( line[0] === '%') {
				var line = line.replace('%', '');
				var keyVal = line.split(' ');

				if (keyVal[0].trim()==='block' && keyVal[1].trim()==='SuperCell')
				{
					isSuperCell=1;
					var start = index+1; var end = start + 3;
					parseSuperCell( lines.slice(start, end), 1);

					
				}

				if (keyVal[0].trim()==='block' && keyVal[1].trim()==='LatticeVectors')
				{
					var start = index+1; var end = start + 3;
					parseLatticeVectors( lines.slice(start, end));
				}

			}

		}

	}



	xi=1; yi=1; zi=1;	

	Draw_VR = document.getElementsByName('Draw_VR');

	container_elem = document.getElementById("id_contents_graph3D_3");
	canvas = new Canvas( container_elem );


    renderer.setClearColor( 0xffffff, 1 );
    renderer.setSize(scene_width, scene_height); 
    renderer.shadowMapEnabled = true;
    renderer.sortObjects = false;
	
	camera = new THREE.PerspectiveCamera(45, scene_width / scene_height, 0.01, 10000);
	trackballControl = new THREE.TrackballControls(camera, renderer.domElement);


	Draw_Atoms(); scene.add( Atoms );
	Draw_Links(); scene.add( Link_Group );

	directionalLight.position.set(3*xmx, 3*ymx, 3*zmx).normalize();
	directionalLight2.position.set(-3*xmx, -3*ymx, -3*zmx).normalize();

	trackballControl.rotateSpeed = 1.0;
	trackballControl.zoomSpeed = 1.0;
	trackballControl.panSpeed = 1.0;

	camera.up = new THREE.Vector3(0.0,0.0,1.0);

	camera.rotation.z=Math.PI*0.5;

	camera.position.set(camera_Vscale*(Dyy+Dzz)+Dxx*0.5, camera_Vscale*(Dzz+Dxx)+Dyy*0.5, camera_Vscale*(Dxx+Dyy)+Dzz*0.5);
	trackballControl.target = new THREE.Vector3((Dxx)*0.5, (Dyy)*0.5, (Dzz)*0.5);
	
	var plate = new Plate();
	arrow_plates[0] = new THREE.LineSegments( new THREE.Geometry(), new THREE.LineBasicMaterial( { color: 0x000000, opacity: 1, linewidth: 1 } ) );
	arrow_plates[0].position.z=0;
	arrow_plates[0].visible = false;

	plate.arrow( arrow_plates[0] );
	plate.vmode(0);
	canvas.addPlate( 'xy', plate );
	scene.add( arrow_plates[0] );

	plate = new Plate();
	arrow_plates[1] = new THREE.LineSegments( new THREE.Geometry(), new THREE.LineBasicMaterial( { color: 0x000000, opacity: 1, linewidth: 1 } ) );
	arrow_plates[1].position.x=0;
	arrow_plates[1].visible = false;
	plate.arrow( arrow_plates[1] );
	plate.vmode(0);
	canvas.addPlate( 'yz', plate );
	scene.add( arrow_plates[1] );

	plate = new Plate();
	arrow_plates[2] = new THREE.LineSegments( new THREE.Geometry(), new THREE.LineBasicMaterial( { color: 0x000000, opacity: 1, linewidth: 1 } ) );
	arrow_plates[2].position.y=0;
	arrow_plates[2].visible = false;
	plate.arrow( arrow_plates[2] );
	plate.vmode(0);
	canvas.addPlate( 'zx', plate );
	scene.add( arrow_plates[2] );

	var plateGeometry = new THREE.Geometry();
	var plateMaterial = new THREE.MeshBasicMaterial({ vertexColors: THREE.VertexColors, transparent:true , opacity: 0.5, side:THREE.DoubleSide });
	plateViewers[0] = new THREE.Mesh( plateGeometry, plateMaterial );
	plateViewers[0].position.z = 0;

	plateViewers[0].visible=false;
	canvas.setPlateGeometry('xy', plateGeometry);
	canvas.setPlateMaterial('xy', plateMaterial);
	canvas.setPlateMesh('xy', plateViewers[0]);
	scene.add( plateViewers[0] );

	plateGeometry = new THREE.Geometry();
	plateMaterial = new THREE.MeshBasicMaterial({ vertexColors: THREE.VertexColors, transparent:true , opacity: 0.5, side:THREE.DoubleSide });
	plateViewers[1] = new THREE.Mesh( plateGeometry, plateMaterial );
	plateViewers[1].position.x = 0;
	plateViewers[1].visible=false;
	canvas.setPlateGeometry('yz', plateGeometry);
	canvas.setPlateMaterial('yz', plateMaterial);
	canvas.setPlateMesh('yz', plateViewers[1]);
	scene.add( plateViewers[1] );

	plateGeometry = new THREE.Geometry();
	plateMaterial = new THREE.MeshBasicMaterial({ vertexColors: THREE.VertexColors, transparent:true , opacity: 0.5, side:THREE.DoubleSide });
	plateViewers[2] = new THREE.Mesh( plateGeometry, plateMaterial );
	plateViewers[2].position.y = 0;
	plateViewers[2].visible=false;
	canvas.setPlateGeometry('zx', plateGeometry);
	canvas.setPlateMaterial('zx', plateMaterial);
	canvas.setPlateMesh('zx', plateViewers[2]);
	scene.add( plateViewers[2] );
	
	setViewerShape('xy');
	setViewerShape('yz');
	setViewerShape('zx');

	setViewerFaces();

	setArrows('xy');
	setArrows('yz');
	setArrows('zx');
		
	
	drawBox(); //<----don't delete 

	document.removeEventListener( 'click', onDocumentMouseMove, false );
	document.addEventListener( 'mousemove', onDocumentMouseMove, false );
	document.addEventListener( 'mouseover', onDocumentMouseOver, false );
	//window.addEventListener( 'resize', onWindowResize, false );
	
	
	
//	document.addEventListener( 'mouseup'  , onDocumentMouseUp, false );
	//document.addEventListener( 'mousedown', onDocumentMouseDown, false );

	MC_effect(0);
	
	animate();


	
}


//-----------------------------------------------------------------
function animate () 
{

	Old_target_x = trackballControl.target.x;	Old_target_y = trackballControl.target.y;	Old_target_z = trackballControl.target.z;
	Old_camera_x = camera.position.x;	        Old_camera_y = camera.position.y;	        Old_camera_z = camera.position.z;
		
	trackballControl.update();

	if(Old_camera_x!=camera.position.x || Old_camera_y!=camera.position.y|| Old_camera_z!=camera.position.z || trackballControl.target.x !=Old_target_x || trackballControl.target.y !=Old_target_y || trackballControl.target.z !=Old_target_z )
	{		
		camera_x = camera.position.x        ; camera_y = camera.position.y        ; camera_z = camera.position.z;
		target_x = trackballControl.target.x; target_y = trackballControl.target.y; target_z = trackballControl.target.z;		
	
		if(exe_mod==0) {
		//	Direc_info = "--Views--: " + camera.position.x +" "+ camera.position.y +" "+camera.position.z + " " + trackballControl.target.x + " " + trackballControl.target.y + " " + trackballControl.target.z ;
		//	document.getElementById("id_Views").value = Direc_info;
		}
	 
	   camera.up = new THREE.Vector3(0.0, 0.0, 1.0);	  
	}
	
	renderer.render(scene, camera );
	requestAnimationFrame(animate);



    
};


function parseParams ( dataLines ) {	

for ( var i=0; i<dataLines.length; i++ ) {
    var line = dataLines[i];

    var values = line.split('=');

    var value0 = values[0].trim();

    var value1 = Number(values[1]); 

    if      (value0 =='Nx')    {Nx    = value1; }
    else if (value0 =='Ny')    {Ny    = value1; }
    else if (value0 =='Nz')    {Nz    = value1; }
    else if (value0 =='N_nod') {N_nod = value1; }
    else if (value0 =='N_t')   {N_t   = value1; }
    else if (value0 =='dx')    {dx_g  = value1*scale_fac;  }
    else if (value0 =='dy')    {dy_g  = value1*scale_fac; }
    else if (value0 =='dz')    {dz_g  = value1*scale_fac; }
    else if (value0 =='xmx')    { }
    else if (value0 =='ymx')    { }
    else if (value0 =='zmx')    { }
    else if (value0 =='xmn')    { }
    else if (value0 =='ymn')    { }
    else if (value0 =='zmn')    { }
    else if (value0 =='P_max')    { }
    else if (value0 =='P_min')    { }
    else if (value0 =='R_max')    { }
    else if (value0 =='R_min')    { }

    else {alert('Un-recognizable parameter: '+ value0); }
    
};	

Nzy=Nz*Ny;
    

document.getElementById("PyzRange").max = Nx;
document.getElementById("PzxRange").max = Ny;
document.getElementById("PxyRange").max = Nz;


};


function parseLinkCoor ( dataLines ) {
		for ( var i=0; i<dataLines.length; i++ ) {
			var avalue = dataLines[i].trim().split(' ');

			Links[0][i][0]=Number(avalue[0]); Links[0][i][1]=Number(avalue[1]); Links[0][i][2]=Number(avalue[2]);

		}
	};

	function parseEPData ( dataLines ) {

//--------------- to get V field  --------------
		
	//if (ON_save_P===0) return;

	var time = '0';
	var xi_L, yi_L, zi_L, md;
	var c1=0.25, c2=0.50, c3=0.75;
	var R_col, G_col, B_col;
	var func= new Array(N_nod);

	Vertices[time] = [];
	Grad = [];


	for ( var i=0; i<dataLines.length; i++ ) {
		var line = dataLines[i];
	//	var values = line.split(',');

		xi_L = parseInt(i/Nzy); md = parseInt(i%Nzy) ;
		yi_L = parseInt(md/Nz);
		zi_L = parseInt(md%Nz);

		func[i]=parseFloat(line);

		if (func[i]>c3 && func[i]<=1.0) { R_col= 1.0 ; G_col= (1.0-func[i])/(1.0-c3) ; B_col= 0.0 ; }
	else if (func[i]>c2 && func[i]<=c3 ) { R_col= (func[i]-c2)/(c3-c2) ; G_col= 1.0 ; B_col= 0.0 ; }
	else if (func[i]>c1 && func[i]<=c2 ) { R_col= 0.0 ; G_col= 1.0 ; B_col= (c2-func[i])/(c2-c1) ; }
	else if (func[i]>=0 && func[i]<=c1 ) { R_col= 0.0 ; G_col= (func[i]-0.0)/(c1-0.0) ; B_col= 1.0 ; }

		var vertex = {};
		vertex.x = xi_L*dx_g;
		vertex.y = yi_L*dy_g;
		vertex.z = zi_L*dz_g;
		vertex.cr = R_col;
		vertex.cg = G_col;
		vertex.cb = B_col;
		vertex.p = func[i];

		Vertices[time].push( vertex );

		if (func[i]> V_mx) V_mx = func[i];  
		if (func[i]< V_mn) V_mn = func[i];

		if (vertex.x > xmx_out) xmx_out = vertex.x;
		if (vertex.x < xmn_out) xmn_out = vertex.x;

		if (vertex.y > ymx_out) ymx_out = vertex.y;
		if (vertex.y < ymn_out) ymn_out = vertex.y;

		if (vertex.z > zmx_out) zmx_out = vertex.z;
		if (vertex.z < zmn_out) zmn_out = vertex.z;

	}

	//--------------- to get E field  --------------

	var ord = new Array(Nx);

	for (var i=0; i<Nx; i++) ord[i] = new Array(Ny);
	for (var i=0; i<Nx; i++)
	for (var j=0; j<Ny; j++) ord[i][j] = new Array(Nz);

	var grad_fx = new Array(N_nod);
	var grad_fy = new Array(N_nod);
	var grad_fz = new Array(N_nod);

	var grad_fx_mx=-1e+100, grad_fy_mx=-1e+100, grad_fz_mx=-1e+100;
	var grad_fx_mn= 1e+100, grad_fy_mn= 1e+100, grad_fz_mn= 1e+100;

	for (var i=0;i<N_nod;i++)
	{
		var dummy;
		xi_L = parseInt(i / (Ny*Nz)) ; dummy = i % (Ny*Nz);
		yi_L = parseInt(dummy / Nz) ;
		zi_L = dummy % Nz ;
		ord[xi_L][yi_L][zi_L] = zi_L + Nz*yi_L + Nz*Ny*xi_L ;
	}


	var Norm_dx = Nx ;
	var Norm_dy = Ny ;
	var Norm_dz = Nz ;




	for (var i=0;i<N_nod;i++)
	{
		var dummy;

		xi_L = parseInt(i / (Ny*Nz)) ; dummy = i % (Ny*Nz);
		yi_L = parseInt(dummy / Nz) ;
		zi_L = dummy % Nz ;

		if (xi_L==0 || xi_L==Nx-1) grad_fx[i] = 0; else grad_fx[i] = ( func[ord[xi_L+1][yi_L][zi_L]] - func[ord[xi_L-1][yi_L][zi_L]] ) / dx_g;
		if (yi_L==0 || yi_L==Ny-1) grad_fy[i] = 0; else grad_fy[i] = ( func[ord[xi_L][yi_L+1][zi_L]] - func[ord[xi_L][yi_L-1][zi_L]] ) / dy_g;
		if (zi_L==0 || zi_L==Nz-1) grad_fz[i] = 0; else grad_fz[i] = ( func[ord[xi_L][yi_L][zi_L+1]] - func[ord[xi_L][yi_L][zi_L-1]] ) / dz_g;

		if (grad_fx[i]> grad_fx_mx) grad_fx_mx = grad_fx[i]; if (grad_fx[i]< grad_fx_mn) grad_fx_mn = grad_fx[i];
		if (grad_fy[i]> grad_fy_mx) grad_fy_mx = grad_fy[i]; if (grad_fy[i]< grad_fy_mn) grad_fy_mn = grad_fy[i];
		if (grad_fz[i]> grad_fz_mx) grad_fz_mx = grad_fz[i]; if (grad_fz[i]< grad_fz_mn) grad_fz_mn = grad_fz[i];

	}

	var diffx_mx = grad_fx_mx - grad_fx_mn;
	var diffy_mx = grad_fy_mx - grad_fy_mn;
	var diffz_mx = grad_fz_mx - grad_fz_mn;

	var grad_lim=16.0;

	for (i=0;i<N_nod;i++)
	{
		var dummy;

		var Norm_grad_x, Norm_grad_y, Norm_grad_z;

		xi_L = parseInt(i / (Ny*Nz)) ; dummy = i % (Ny*Nz);
		yi_L = parseInt(dummy / Nz) ;
		zi_L = dummy % Nz ;

		Norm_grad_x = -grad_fx[i]/diffx_mx ; if (Math.abs(Norm_grad_x)>grad_lim*Norm_dx) Norm_grad_x = Norm_grad_x/Math.abs(Norm_grad_x)*grad_lim*Norm_dx ;
		Norm_grad_y = -grad_fy[i]/diffy_mx ; if (Math.abs(Norm_grad_y)>grad_lim*Norm_dy) Norm_grad_y = Norm_grad_y/Math.abs(Norm_grad_y)*grad_lim*Norm_dy ;
		Norm_grad_z = -grad_fz[i]/diffz_mx ; if (Math.abs(Norm_grad_z)>grad_lim*Norm_dz) Norm_grad_z = Norm_grad_z/Math.abs(Norm_grad_z)*grad_lim*Norm_dz ;



		var xyz = {
			x: Norm_grad_x,
			y: Norm_grad_y,
			z: Norm_grad_z
		};
		Grad.push( xyz );
		
	}


};

function parseRhoData ( dataLines ) {

//if (ON_save_R===0) return;

var time = '0';
var xi_L, yi_L, zi_L, md;
var c1=0.25, c2=0.50, c3=0.75;
var R_col, G_col, B_col;
var func;

Rhos[time] = [];

for ( var i=0; i<dataLines.length; i++ ) {
   var line = dataLines[i];

   func=parseFloat(line);

   if (func>c3 && func<=1.0) { R_col= 1.0 ; G_col= (1.0-func)/(1.0-c3) ; B_col= 0.0 ; }
else if (func>c2 && func<=c3 ) { R_col= (func-c2)/(c3-c2) ; G_col= 1.0 ; B_col= 0.0 ; }
else if (func>c1 && func<=c2 ) { R_col= 0.0 ; G_col= 1.0 ; B_col= (c2-func)/(c2-c1) ; }
else if (func>=0 && func<=c1 ) { R_col= 0.0 ; G_col= (func-0.0)/(c1-0.0) ; B_col= 1.0 ; }

   //var rhos = line.split(',');

   xi_L = parseInt(i/Nzy); md = parseInt(i%Nzy) ;
   yi_L = parseInt(md/Nz);
   zi_L = parseInt(md%Nz);
   

   var vertex = {};
   vertex.x = xi_L*dx_g;
   vertex.y = yi_L*dy_g;
   vertex.z = zi_L*dz_g;

   vertex.cr = R_col;
   vertex.cg = G_col;
   vertex.cb = B_col;
   vertex.p = func;
   Rhos[time].push( vertex );

}


};


function movePlate( plateId ) {

	
	var valueInput = document.getElementById('P'+plateId+'Range');

	var V_mode = 0;

	var posInput = 'P'+plateId+'Input1';
	switch( plateId ) {
		case 'xy':
			zi = valueInput.value;

			if (Draw_VR[0].checked) { document.getElementById(posInput).value = Vertices['0'][zi-1].z; }
			if (Draw_VR[1].checked) { document.getElementById(posInput).value = Rhos['0'][zi-1].z; }

			break;
		case 'yz':
			xi = valueInput.value;

			if (Draw_VR[0].checked) { document.getElementById(posInput).value = Vertices['0'][Nz*Ny*(xi-1)].x; }
			if (Draw_VR[1].checked) { document.getElementById(posInput).value = Rhos['0'][Nz*Ny*(xi-1)].x; }

			break;
		case 'zx':
			yi = valueInput.value;

			if (Draw_VR[0].checked) { document.getElementById(posInput).value = Vertices['0'][Nz*(yi-1)].y; }
			if (Draw_VR[1].checked) { document.getElementById(posInput).value = Rhos['0'][Nz*(yi-1)].y; }
			break;
	}

	setViewerShape(plateId);
	setPlateMode(plateId, V_mode);

	var plateMesh = canvas.getPlateMesh(plateId);
	plateMesh.geometry.elementsNeedUpdate = true;

	setArrows(plateId);
}


function removeAllObjects()
{
	scene.remove( Atoms ); 
	scene.remove( Link_Group ); 
	scene.remove( BoxLineGroup ); 
	scene.remove(BoxGroup); 

	Atoms        = new THREE.Object3D();
	Link_Group   = new THREE.Object3D();
	aBoxLine     = new THREE.Object3D();
	BoxLineGroup = new THREE.Object3D();
	BoxGroup     = new THREE.Object3D();

	for (var i=0; i<3;i++){ scene.remove(plateViewers[i]); scene.remove(arrow_plates[i]);}

}
//-----
function onWindowResize() {
	scene_width = document.body.clientWidth;
	scene_height= document.body.clientHeight;

	
	
	camera.aspect = scene_width / scene_height;
	camera.updateProjectionMatrix();

	renderer.setSize( scene_width, scene_height );

}
//----------------------------------------------------
function parseLatticeVectors ( dataLines ) 
{
	

    for ( var i=0; i<3; i++ )
    {
        dataLines[i]=dataLines[i].replace(/ +/g, " ");
        var avalue = dataLines[i].trim().split(' ');

		LatticeVector[i].set(Number(avalue[0]), Number(avalue[1]), Number(avalue[2]) );	

        //LatticeVector[i] = Number(avalue[i]);	
		
	
		
    }
};

function parseSuperCell ( dataLines, mode ) 
{
    //dataLines.replace( /\t/gi, " ");

	

    for ( var i=0; i<3; i++ ){ var avalue = dataLines[i].trim().split(' '); 
	//	if (mode==0) SuperCell_in[i]=avalue[i]; 
	//	if (mode==1) SuperCell_out[i]=avalue[i]; 
		if (mode==2) SuperCell[i] = 1; 
    }

};


function parseAtomCoor( dataLines )
	{
				
		Define_P_Atoms(N_Atoms);
		
		for ( var i=0; i<dataLines.length; i++ ) {
			var avalue = dataLines[i].trim().split(' ');

			P_Atoms[0][i][0]=avalue[0];
			P_Atoms[0][i][1]=avalue[1]; 
			P_Atoms[0][i][2]=avalue[0];
			P_Atoms[0][i][3]=Number(avalue[3])*scale_fac;
			P_Atoms[0][i][4]=Number(avalue[4])*scale_fac;
			P_Atoms[0][i][5]=Number(avalue[5])*scale_fac;
			P_Atoms[0][i][6]=Number(avalue[6]);

			for (var j=0; j<5;j++)
			{
				if ( isNaN(P_Atoms[0][i][2].substring(j,1))===true ) break;
			}

			P_Atoms[0][i][2]=P_Atoms[0][i][2].substring(j-1);
			
		}
		
		
		
	};
 //---------------------------------------------------------------------------------------------------------
 function Define_P_Atoms(Def_N_Atom)
{

        P_Atoms=[];
        P_Atoms= new Array(1) ;

    for (var i=0; i<N_t ; i++)
    {
        P_Atoms[i] = new Array(Def_N_Atom);
        for (var j=0; j<Def_N_Atom; j++)
        {
            P_Atoms[i][j] = new Array(7);
        }
    }


}


//---------------------------------------------------------------------------------------------------------
function Define_Links()
{

	for (var i=0; i<N_t ; i++)
	{
		Links[i] = new Array(N_links);
		for (var j=0; j<N_links; j++)
		{
			Links[i][j] = new Array(3);
		}
	}
}


//---------
function Draw_Atoms()
{
// var Num_loaded_Atoms = P_Atoms[t_i].length;

var j=0;
var i=0;

xmx= -1e1000; ymx= -1e1000; zmx= -1e1000;
xmn=  1e1000; ymn=  1e1000;  zmn= 1e1000;

for (var i=0; i<N_Atoms; i++)
{
	   if (P_Atoms[0][i][6]==1) continue;
	  
	  atom_Geo[i] = new THREE.SphereGeometry(Atom_R[P_Atoms[0][i][1]],15,15);
	  atom_Mat[i] = new THREE.MeshStandardMaterial({color: Number('0x'+Atom_color[P_Atoms[0][i][1]]) });

	  atom[j] = new THREE.Mesh(atom_Geo[i],atom_Mat[i]);
	  atom[j].position.set(P_Atoms[0][i][3], P_Atoms[0][i][4], P_Atoms[0][i][5]);
	  atom[j].castShadow = true;
	   
	  if (atom[j].position.x>xmx) xmx=atom[j].position.x; if (atom[j].position.y>ymx) ymx=atom[j].position.y; if (atom[j].position.z>zmx) zmx=atom[j].position.z;
	  if (atom[j].position.x<xmn) xmn=atom[j].position.x; if (atom[j].position.y<ymn) ymn=atom[j].position.y; if (atom[j].position.z<zmn) zmn=atom[j].position.z;

	  Atoms.add(atom[j]);
	  Atoms.children[j].name=j;

	  nonz_i[j]=i;

	  j++;
	  
	
}

Dxx = xmx-xmn;
Dyy = ymx-ymn;
Dzz = zmx-zmn;

dx = 1.5*Dxx/(N_Range*SuperCell[0]); dy = 1.5*Dyy/(N_Range*SuperCell[1]); dz = 1.5*Dzz/(N_Range*SuperCell[2]);


//iid=Number(Atoms.children[0].id);

}

//---------------------------------------------------------------------------------------------------------
function Draw_Links()
{

	console.log('Links');
	console.log(Links);


	for (var i=0; i<Links[t_i].length; i++)
	{

		var EB_points = [];

		EB_points[0]= new THREE.Vector3(P_Atoms[t_i][Links[t_i][i][0]][3] , P_Atoms[t_i][Links[t_i][i][0]][4] , P_Atoms[t_i][Links[t_i][i][0]][5]) ;
		EB_points[1]= new THREE.Vector3(P_Atoms[t_i][Links[t_i][i][1]][3] , P_Atoms[t_i][Links[t_i][i][1]][4] , P_Atoms[t_i][Links[t_i][i][1]][5]) ;

		Link[i] = new THREE.Mesh( new THREE.TubeGeometry( new THREE.CatmullRomCurve3(EB_points), 0, 0.06, 6, true ), new THREE.MeshStandardMaterial( { color: Link_color, transparent:true, opacity:0.8 } ) );

		Link_Group.add(Link[i]);
		
	}

}

function drawBox () {
		
		var BLines = [];

		var LV_a ;//= new THREE.Vector3( ) ;	
		var LV_b ;//= new THREE.Vector3( ) ; 
		var LV_c ;//= new THREE.Vector3( ) ;		

		LV_a = LatticeVector[0];	LV_b = LatticeVector[1]; LV_c = LatticeVector[2]; 

	

				
	
		var dummy = new THREE.Vector3( );
		LV_a = dummy.copy(LV_a).multiplyScalar(Lattice_C);
		var dummy = new THREE.Vector3( );
		LV_b = dummy.copy(LV_b).multiplyScalar(Lattice_C);
		var dummy = new THREE.Vector3( );
		LV_c = dummy.copy(LV_c).multiplyScalar(Lattice_C);

		

		

		var dummy = new THREE.Vector3( );
		var LV_a_b  = dummy.copy(LV_a).add(LV_b);	
		
		var dummy = new THREE.Vector3( );
		var LV_b_c   = dummy.copy(LV_b).add(LV_c);
	
		var dummy = new THREE.Vector3( );
		var LV_c_a   = dummy.copy(LV_c).add(LV_a);	

		var dummy = new THREE.Vector3( );
		var LV_a_b_c = dummy.copy(LV_a_b).add(LV_c);	

		var Lines_p = [new THREE.Vector3( 0, 0, 0), LV_a, LV_a_b, LV_b , LV_c, LV_c_a, LV_a_b_c, LV_b_c];

		
			
		var LL = [[0,1],[1,2],[2,3],[3,0],[4,5],[5,6],[6,7],[7,4],[0,4],[1,5],[2,6],[3,7]];

		var N_Lines = LL.length;

		

		aBoxLine = new THREE.Object3D();	
		
		for ( var i=0;i<=N_Lines-1; i++)
		{
			BLines[i] = {};
			BLines[i].geo = new THREE.Geometry();

			BLines[i].geo.vertices.push(Lines_p[LL[i][0]]);
			BLines[i].geo.vertices.push(Lines_p[LL[i][1]]);


			BLines[i].mat = new THREE.LineDashedMaterial( { color: 0x666666, linewidth: 1, scale:1, dashSize: 3, gapSize: 1 } );
			BLines[i].mesh = new THREE.Line( BLines[i].geo, BLines[i].mat );			

			aBoxLine.add(BLines[i].mesh);
		}

		var SuperCell_0 , SuperCell_1 , SuperCell_2 ;

		SuperCell_0 = SuperCell[0]; SuperCell_1 = SuperCell[1]; SuperCell_2 = SuperCell[2];
			
		var BoxLines    = new Array(SuperCell_0);

		for (var i=0; i<SuperCell_0; i++) BoxLines[i] = new Array(SuperCell_1);
		for (var i=0; i<SuperCell_0; i++)
		for (var j=0; j<SuperCell_1; j++) BoxLines[i][j] = new Array(SuperCell_2);

		scene.remove( BoxLineGroup ); BoxLineGroup = new THREE.Object3D();

		for (var i=0; i<SuperCell_0; i++)
		{
			var dummy = new THREE.Vector3( ); var supar_LV_a = dummy.copy(LV_a).multiplyScalar(i);
			for (var j=0; j<SuperCell_1; j++)
			{
				var dummy = new THREE.Vector3( ); var supar_LV_b = dummy.copy(LV_b).multiplyScalar(j);
				for (var k=0; k<SuperCell_2; k++)
				{
					var dummy = new THREE.Vector3( ); var supar_LV_c = dummy.copy(LV_c).multiplyScalar(k);

					var dummy_add = new THREE.Vector3(0,0,0);
					
					dummy_add  = dummy_add.add(supar_LV_a);	
					dummy_add  = dummy_add.add(supar_LV_b);	
					dummy_add  = dummy_add.add(supar_LV_c);	

					BoxLines[i][j][k]=aBoxLine.clone();
					BoxLines[i][j][k].position.set(dummy_add.x, dummy_add.y, dummy_add.z);

				
					
					BoxLineGroup.add(BoxLines[i][j][k]);
					
				}
			}
		}

		

		
		scene.add( BoxLineGroup );



	}; // End of drawAxis()
//------------------------------------
var effect, resolution;
var effect2;

function MC_effect(mode)
{
	var color_MC= new THREE.Color( 0.9, 0.9, 0.9 );
	var materials = new THREE.MeshStandardMaterial({opacity: 0.4, color: color_MC, transparent:true, side:THREE.DoubleSide}) ;
	
	var front_material = new THREE.MeshStandardMaterial({opacity: 0.4, color: color_MC, transparent:true, side: THREE.FrontSide}) ;
	var back_material = new THREE.MeshStandardMaterial({opacity: 0.4, color: color_MC, transparent:true, side: THREE.BackSide}) ;

	//var front_material = new THREE.MeshStandardMaterial({opacity: 1.0, color: new THREE.Color( 1.0, 0.0, 0.0 ), transparent:true, side: THREE.FrontSide}) ;
	//var back_material = new THREE.MeshStandardMaterial({opacity: 1.0, color: new THREE.Color( 0.0, 0.0, 1.0 ), transparent:true, side: THREE.BackSide}) ;


	var eqv_surf_resolution = 40;


	var Equi_v = document.getElementById('MC_Range').value;

	document.getElementById('MC_Range_text').value = Equi_v;

	if (typeof(eqv_surf_f)!="undefined") {eqv_surf_f.reset();}

	

	if (typeof(eqv_surf_b)!="undefined") {eqv_surf_b.reset();}

	

	//var mesh = new THREE.Mesh( geometry, [frontMaterial, backMaterial] );
//	eqv_surf_f = new THREE.MarchingCubes( eqv_surf_resolution, materials, false, true );

  var materials = [ front_material, back_material ];
  //var materials = [ materials, materials ];
  

  var material = new THREE.MeshFaceMaterial( materials );


	eqv_surf_f = new THREE.MarchingCubes( eqv_surf_resolution, front_material, false, true );
	eqv_surf_f.position.set( xmx_out/2, ymx_out/2, zmx_out/2 );
	eqv_surf_f.scale.set(  xmx_out*0.5,  ymx_out*0.5,  zmx_out*0.5 );
	
	
	
	eqv_surf_f.reset();

	eqv_surf_b = new THREE.MarchingCubes( eqv_surf_resolution, back_material, false, true );
	eqv_surf_b.position.set( xmx_out/2, ymx_out/2, zmx_out/2 );
	eqv_surf_b.scale.set(  xmx_out*0.5,  ymx_out*0.5,  zmx_out*0.5 );

	if(mode==1)
	{

		scene_out.remove( eqv_surf_f );
		scene_out.remove( eqv_surf_b );
		
		scene_out.add( eqv_surf_f );
		scene_out.add( eqv_surf_b );

	}

	eqv_surf_b.reset();

	var subtract, strength;

		subtract = 5.0;			
		strength = 0.05;

	var vertices = Vertices[0];	
	
	for(var i=0; i<Nx; i++)	{
	for(var j=0; j<Ny; j++)	{
	for(var k=0; k<Nz; k++)	{
				
		var ord_xyz = k + j*Nz + i*Nz*Ny;
		if (vertices[ord_xyz].p<Equi_v)
		{			
			eqv_surf_f.addBall(vertices[ord_xyz].x/xmx_out, vertices[ord_xyz].y/ymx_out, vertices[ord_xyz].z/zmx_out, strength, subtract);			
			eqv_surf_b.addBall(vertices[ord_xyz].x/xmx_out, vertices[ord_xyz].y/ymx_out, vertices[ord_xyz].z/zmx_out, strength, subtract);			

		}
	}}}

}


var Graph_2D_layout = {		
	showlegend: false,
	autosize: false,
	margin: {	l: 20,	r: 20,	b: 20,	t: 10  },  width: 540, height: 400,	

	xaxis: { autorange: true,	showgrid: true,	zeroline: false,	showline: true,	autotick: true,	//ticks: '',
		showticklabels: true
	},

	yaxis: {
		//autorange: true,
		//range: [-5, 5],	showgrid: true,	zeroline: false, showline: true, autotick: true,	//ticks: '',
		autorange: true,	showgrid: true,	zeroline: false, showline: true, autotick: true,	//ticks: '',
		showticklabels: true}


};


  function Draw_oneDplot(target, temp_string)
  {	

	// clear --------------------------------

	document.getElementById(target).innerHTML ="";


	var data_string;

    data_string = temp_string;
	
	var lines = data_string.split('\n');
    
	var L_i =0 ;
	
	var N_field   = lines[L_i++].split(':')[1];

	var line1_arr = lines[L_i++].split(',');
	var Label_x = (line1_arr[0].split(':')[1]).trim();
	var Label_y = (line1_arr[1].split(':')[1]).trim();

	var Name_subsection = new Array(N_field); 

	var OneD_x = new Array(N_field);
	var OneD_y = new Array(N_field);
	
		
	for ( var i=0; i<N_field ; i++ ) 
	{
		
		var head_lines_arr = lines[L_i++].split(',')

		    Name_subsection[i] = (head_lines_arr[0].split(':')[1]).trim();
		var N_subsection       = Number(head_lines_arr[1].split(':')[1]);
	
		OneD_x[i] = new Array(0); 
		OneD_y[i] = new Array(0); 


		for ( var j=0; j<N_subsection ; j++ ) 
		{			
			var xy_arr = lines[L_i++].split(',');
			OneD_x[i].push(Number(xy_arr[0]));
			OneD_y[i].push(Number(xy_arr[1]));			
		}

	
	}		
	

	var trace = new Array(N_field);
	var trace_name = new Array(N_field);

	var data = [];

	for(var i=0; i<N_field ;i++)
	{

		trace_name[i] = Name_subsection[i];  		  

		trace[i] = { x: [], y: [], name: trace_name[i], type: 'scatter' };

		trace[i].x = OneD_x[i]; trace[i].y = OneD_y[i];		  

		data.push(trace[i]);

	}

	Plotly.newPlot(target, data, Graph_2D_layout);

}


function setViewerShape ( plateId )
	{

		var outMax, inMax, order, xyzp;
		switch( plateId ) {
			case 'xy':
				outMax = Nx;
				inMax = Ny;
				order = function(i, j){ return (zi-1) + Nz*(j-1) + Nz*Ny*(i-1); };
				xyzp = function( i, j ){ return (j-1 ) + Ny*(i-1); };
				break;
			case 'yz':
				outMax = Ny;
				inMax = Nz;
				order = function(j, k){ return (k-1) + Nz*(j-1) + Nz*Ny*(xi-1); };
				xyzp = function( j, k ){ return (k-1) + Nz*(j-1); };
				break;
			case 'zx':
				outMax = Nz;
				inMax = Nx;
				order = function(k, i){ return (k-1) + Nz*(yi-1) + Nz*Ny*(i-1); };
				xyzp = function( k, i ){ return (i-1) + Nx*(k-1); };
				break;
		}

		var plate = canvas.getPlate( plateId );
		var geometry = plate.geometry();


//		for (var i = 0; i < rates.length; i++) {

//		    if (rates[i].checked) {

	//	        rate_value = rates[i].value;
		//    }

	//	}
		if (Draw_VR[0].checked) { var vertices = Vertices['0']; }
		if (Draw_VR[1].checked) { var vertices = Rhos['0']; }

		for (var i=1; i<=outMax ; i++) {
			for (var j=1; j<=inMax ; j++) {
				var ord_data = order( i, j );
				var ord_XYP = xyzp( i, j );

				geometry.vertices[ord_XYP]=
					new THREE.Vector3(
					                  vertices[ord_data].x + (plateId=="yz"? 1:0)* vertices[ord_data].p*plate.vmode(),
					                  vertices[ord_data].y - (plateId=="zx"? 1:0)* vertices[ord_data].p*plate.vmode(),
					                  vertices[ord_data].z + (plateId=="xy"? 1:0)* vertices[ord_data].p*plate.vmode() ) ;
			}
		}



	};

	//---------------------------------------------------------------------------------------------------------
	function setViewerFaces () {
		var geoXY = canvas.getPlateGeometry('xy');
		var geoYZ = canvas.getPlateGeometry('yz');
		var geoZX = canvas.getPlateGeometry('zx');

		for (var i=1; i<=Nx-1; i++) {
			for (var j=1; j<=Ny-1; j++) {
				var ord_XYP = (j-1) + Ny*(i-1);
//				geoXY.faces.push( new THREE.Face3(ord_XYP + Ny  , ord_XYP+1, ord_XYP     ) );
	//			geoXY.faces.push( new THREE.Face3(ord_XYP + Ny+1, ord_XYP+1, ord_XYP + Ny) );

				geoXY.faces.push( new THREE.Face3(ord_XYP , ord_XYP+1, ord_XYP + Ny ) );
				geoXY.faces.push( new THREE.Face3(ord_XYP + Ny, ord_XYP+1, ord_XYP + Ny+1) );

			}
		}

		    //--------------------------------------- YZ �� ---------------------------

		for (var j=1; j<=Ny-1; j++) {
			for (var k=1; k<=Nz-1; k++) {
				var ord_YZP = (k-1) + Nz*(j-1);

//				geoYZ.faces.push( new THREE.Face3(ord_YZP     , ord_YZP + Nz  , ord_YZP+1  ) );
	//			geoYZ.faces.push( new THREE.Face3(ord_YZP + Nz, ord_YZP + Nz+1, ord_YZP+1) );

				geoYZ.faces.push( new THREE.Face3(ord_YZP , ord_YZP + 1 , ord_YZP+Nz ) );
				geoYZ.faces.push( new THREE.Face3(ord_YZP + Nz, ord_YZP + 1, ord_YZP+Nz+1) );

			}
		}

		    //--------------------------------------- ZX �� ---------------------------

		for (var k=1; k<=Nz-1; k++) {
			for (var i=1; i<=Nx-1; i++) {
				var ord_ZXP = (i-1) + Nx*(k-1);

				geoZX.faces.push( new THREE.Face3(ord_ZXP , ord_ZXP+1, ord_ZXP + Nx ) );
				geoZX.faces.push( new THREE.Face3(ord_ZXP + Nx, ord_ZXP+1, ord_ZXP + Nx+1) );
			}
		}
	};

	function setPlateMode( plateId, mode )
{
	var plate = canvas.getPlate(plateId);

	var ord_XYP=0;
	var ord_YZP=0;
	var ord_ZXP=0;

	var ord_data=0;

	var f = 0;

	var axisMax = {};
	switch( plateId ) {
		case 'xy':
			axisMax.i = Nx-1;
			axisMax.j = Ny-1;
			axisMax.ord = function( i, j ){ return (zi-1) + Nz*(j -1) + Nz*Ny*(i -1);}
			axisMax.vf = [ [0 , Nz, Nz*Ny ], [Nz*Ny, Nz, Nz*Ny+Nz] ];
			break;
		case 'yz':
			axisMax.i = Ny-1;
			axisMax.j = Nz-1;
			axisMax.ord = function( i, j ){ return (j -1) + Nz*(i -1) + Nz*Ny*(xi-1); }
			axisMax.vf = [ [ 0, 1, Nz ], [Nz, 1, Nz+1] ];
			break;
		case 'zx':
			axisMax.i = Nz-1;
			axisMax.j = Nx-1;
			axisMax.ord = function( i, j ){ return (i -1) + Nz*(yi-1) + Nz*Ny*(j -1); }
			axisMax.vf = [ [0, Nz*Ny, 1 ], [1, Nz*Ny, 1+ Nz*Ny] ];
			break;
	}

	if (Draw_VR[0].checked) { var vertices = Vertices['0']; }
	if (Draw_VR[1].checked) { var vertices = Rhos['0']; }
//	if (Draw_VR[2].checked) { var vertices = Rhos['0']; }

	//var vertices = Vertices['0'];

	var geometry = plate.geometry();

	var iMax = axisMax.i;
	var jMax = axisMax.j;
	switch(mode) {
		case 0:
			for (var i=1; i<=iMax; i++) {
				for (var j=1; j<=jMax; j++) {
					var ord = axisMax.ord(i, j);

					for (var k=0; k<=1; k++)
					{
						var vf = axisMax.vf[k];
						for ( var kk=0; kk <=2; kk++ ) {
							geometry.faces[f].vertexColors[kk] = new THREE.Color(
			                                                     vertices[ord + vf[kk]].cr,
			                                                     vertices[ord + vf[kk]].cg,
			                                                     vertices[ord + vf[kk]].cb);
						}
						f++;
					}
				}
			}
			break;

	}
};

function setArrows( plateId )
{
		var plate = canvas.getPlate( plateId );
		var i_arr=0;
		var arrow_L = 0.5;
		var s_L=0.4;
		var expan=2;

		var arrow = canvas.getPlateArrow( plateId );
		var geometry = arrow.geometry;

		var outMax, inMax, order;

		var vertices = Vertices[0];

		switch( plateId ) {
			case 'xy':
				outMax = Nx;
				inMax = Ny;
				order = function(i, j){ return (zi-1) + Nz*j + Nzy*i ; };

				for (var i=0; i<outMax; i=i+expan) {
					for (var j=0; j<inMax; j=j+expan) {
						var ord = order(i, j);

						var x0=vertices[ord].x - Grad[ord].x*arrow_L*expan;
						var y0=vertices[ord].y - Grad[ord].y*arrow_L*expan;
						var x1=vertices[ord].x + Grad[ord].x*arrow_L*expan;
						var y1=vertices[ord].y + Grad[ord].y*arrow_L*expan;

						geometry.vertices[i_arr++]= new THREE.Vector3(x0, y0, vertices[ord].z) ;
						geometry.vertices[i_arr++]= new THREE.Vector3(x1, y1, vertices[ord].z) ;

						var x2 = ((x0-x1)*Math.cos(ang)-(y0-y1)*Math.sin(ang))*s_L+x1, y2 = ((x0-x1)*Math.sin(ang)+(y0-y1)*Math.cos(ang))*s_L+y1;

						geometry.vertices[i_arr++]= new THREE.Vector3(x1, y1, vertices[ord].z) ;
						geometry.vertices[i_arr++]= new THREE.Vector3(x2, y2, vertices[ord].z) ;

						var x3 = ((x0-x1)*Math.cos(-ang)-(y0-y1)*Math.sin(-ang))*s_L+x1, y3 = ((x0-x1)*Math.sin(-ang)+(y0-y1)*Math.cos(-ang))*s_L+y1;

						geometry.vertices[i_arr++]= new THREE.Vector3(x1, y1, vertices[ord].z) ;
						geometry.vertices[i_arr++]= new THREE.Vector3(x3, y3, vertices[ord].z) ;

					}
				}

				break;
			case 'yz':
				outMax = Ny;
				inMax = Nz;
				order = function(j, k){ return k + Nz*j + Nzy*(xi-1) ; };

				for (var j=0; j<outMax; j=j+expan)
				{
				  for (var k=0; k<inMax; k=k+expan)
				  {
					  var ord = order(j,k);


						 var y0=vertices[ord].y- Grad[ord].y*arrow_L*expan;
						 var z0=vertices[ord].z- Grad[ord].z*arrow_L*expan;
						 var y1=vertices[ord].y+ Grad[ord].y*arrow_L*expan;
						 var z1=vertices[ord].z+ Grad[ord].z*arrow_L*expan;

						 geometry.vertices[i_arr++]= new THREE.Vector3(vertices[ord].x, y0, z0) ;
						 geometry.vertices[i_arr++]= new THREE.Vector3(vertices[ord].x, y1, z1) ;

						 var y2 = ((y0-y1)*Math.cos(ang)-(z0-z1)*Math.sin(ang))*s_L+y1;
						 var z2 = ((y0-y1)*Math.sin(ang)+(z0-z1)*Math.cos(ang))*s_L+z1;

						 geometry.vertices[i_arr++]= new THREE.Vector3(vertices[ord].x, y1, z1) ;
						 geometry.vertices[i_arr++]= new THREE.Vector3(vertices[ord].x, y2, z2) ;

						 var y3 = ((y0-y1)*Math.cos(-ang)-(z0-z1)*Math.sin(-ang))*s_L+y1;
						 var z3 = ((y0-y1)*Math.sin(-ang)+(z0-z1)*Math.cos(-ang))*s_L+z1;

						 geometry.vertices[i_arr++]= new THREE.Vector3(vertices[ord].x, y1, z1) ;
						 geometry.vertices[i_arr++]= new THREE.Vector3(vertices[ord].x, y3, z3) ;

					}
				}
				break;
			case 'zx':
				outMax = Nz;
				inMax = Nx;
				order = function(k, i){ return k + Nz*(yi-1) + Nzy*i ; };

				for (var k=0; k<outMax ; k=k+expan)
				   {
					for (var i=0; i<inMax ; i=i+expan)
					 {
							 var ord = order(k,i);
							 var z0=vertices[ord].z- Grad[ord].z*arrow_L*expan;
							 var x0=vertices[ord].x- Grad[ord].x*arrow_L*expan;
							 var z1=vertices[ord].z+ Grad[ord].z*arrow_L*expan;
							 var x1=vertices[ord].x+ Grad[ord].x*arrow_L*expan;

							 geometry.vertices[i_arr++]= new THREE.Vector3(x0, vertices[ord].y, z0) ;
							 geometry.vertices[i_arr++]= new THREE.Vector3(x1, vertices[ord].y, z1) ;

							 var x2 = ((x0-x1)*Math.cos(ang)-(z0-z1)*Math.sin(ang))*s_L+x1;
							 var z2 = ((x0-x1)*Math.sin(ang)+(z0-z1)*Math.cos(ang))*s_L+z1;

							 geometry.vertices[i_arr++]= new THREE.Vector3(x1, vertices[ord].y, z1) ;
							 geometry.vertices[i_arr++]= new THREE.Vector3(x2, vertices[ord].y, z2) ;

							 var x3 = ((x0-x1)*Math.cos(-ang)-(z0-z1)*Math.sin(-ang))*s_L+x1;
							 var y3 = ((x0-x1)*Math.sin(-ang)+(z0-z1)*Math.cos(-ang))*s_L+z1;

							 geometry.vertices[i_arr++]= new THREE.Vector3(x1, vertices[ord].y, z1) ;
							 geometry.vertices[i_arr++]= new THREE.Vector3(x3, vertices[ord].y, y3) ;
						}
					  }

				break;
		}

		if ( arrow.visible )
			geometry.verticesNeedUpdate = true;
	};

	function toggleView( plateId ) {
	setPlateMode('xy',0);
	setPlateMode('yz',0);
	setPlateMode('zx',0);

	var checkInput = document.getElementById('P'+plateId+'_visible');

	var mesh = canvas.getPlateMesh(plateId);
	

	if ( checkInput.checked ) {

		mesh.visible=true;
		mesh.geometry.elementsNeedUpdate = true;
	}
	else {
		mesh.visible = false;
	}
}
//-----------------------------------------------
function toggleTerrain( plateId ) {

	var plate = canvas.getPlate( plateId );
	var vmodeInput = document.getElementById('P'+plateId+'_mode');
	var arrowInput = document.getElementById('P'+plateId+'_arr_visible');

	if ( vmodeInput.checked ) {
		plate.vmode( 1 );
	}
	else {
		plate.vmode( 0 );
		if ( arrowInput.checked )
			plate.visibleArrow(true);
	}

	setViewerShape( plateId );

	var mesh = plate.mesh();
	mesh.geometry.elementsNeedUpdate = true;

}

function toggleArrows( plateId ) {


	var checkInput = document.getElementById('P'+plateId+'_arr_visible');

	

	var plate = canvas.getPlate( plateId );
	plate.visibleArrow(checkInput.checked);
	
}


//---------------------------------------------------------------------
function onDocumentMouseMove( event )
{	

	event.preventDefault();

	mouse.x = (event.offsetX / scene_width) * 2 - 1;
	mouse.y = -(event.offsetY / scene_height) * 2 + 1;

	raycaster.setFromCamera( mouse, camera );

	var intersects = raycaster.intersectObjects( Atoms.children );

	if ( intersects.length > 0 )
	{
		if ( INTERSECTED != intersects[ 0 ].object )
		{
			
			if ( INTERSECTED ) INTERSECTED.material.color.setHex( INTERSECTED.currentHex );

			INTERSECTED = intersects[ 0 ].object;
			INTERSECTED.currentHex = INTERSECTED.material.color.getHex();
			//INTERSECTED.material.emissive.setHex( 0x666666 );
			INTERSECTED.material.color.setHex( 0xffffff );

			insec_name=Number(INTERSECTED.name);
			//insec_name=Number(intersects[ 0 ].object);

            document.getElementById("id_text_atom_info").value = P_Atoms[0][nonz_i[insec_name]][0] + "\n";

            document.getElementById("id_text_atom_info").value += "x: " + String(Number(P_Atoms[0][nonz_i[insec_name]][3]).toFixed(4)) + "\n";
            document.getElementById("id_text_atom_info").value += "y: " + String(Number(P_Atoms[0][nonz_i[insec_name]][4]).toFixed(4)) + "\n";
            document.getElementById("id_text_atom_info").value += "z: " + String(Number(P_Atoms[0][nonz_i[insec_name]][5]).toFixed(4));



			container_elem.style.cursor = 'pointer';

		}

	}
	else
	{		
			if ( INTERSECTED ) 
			{
				INTERSECTED.material.color.setHex( INTERSECTED.currentHex );

				

				INTERSECTED = null;

				document.getElementById("id_text_atom_info").value = "";
				container_elem.style.cursor = 'default';
			}
		

	}

	
}


function Sel_Draw_VR(mode)
{
	var plateId;
	var plateMesh;
	var valueInput ;
	var posInput ;

	var V_mode = 0;
	
	var i;
	
	if(mode===0 || mode===1)
	{
		

	if (document.getElementById('Pxy_visible').checked)
	{

		plateId='xy';

		valueInput = document.getElementById('P'+plateId+'Range');
		posInput = 'P'+plateId+'Input1';

		zi = valueInput.value;

		if (mode==0) { document.getElementById(posInput).value = Vertices['0'][zi-1].z; }
		if (mode==1) { document.getElementById(posInput).value = Rhos['0'][zi-1].z; }

		setViewerShape(plateId);
		setPlateMode(plateId, V_mode);

		plateMesh = canvas.getPlateMesh(plateId);
		plateMesh.geometry.elementsNeedUpdate = true;
	}

	if (document.getElementById('Pyz_visible').checked)
	{

		plateId='yz';

		valueInput = document.getElementById('P'+plateId+'Range');
		posInput = 'P'+plateId+'Input1';

		xi = valueInput.value;

		if (mode==0) { document.getElementById(posInput).value = Vertices['0'][Nz*Ny*(xi-1)].x; }
		if (mode==1) { document.getElementById(posInput).value = Rhos['0'][Nz*Ny*(xi-1)].x; }

		setViewerShape(plateId);
		setPlateMode(plateId, V_mode);

		plateMesh = canvas.getPlateMesh(plateId);
		plateMesh.geometry.elementsNeedUpdate = true;

	}

	if (document.getElementById('Pzx_visible').checked)
	{
		plateId='zx';
		valueInput = document.getElementById('P'+plateId+'Range');
		posInput = 'P'+plateId+'Input1';

		yi = valueInput.value;

		if (mode==0) { document.getElementById(posInput).value = Vertices['0'][Nz*(yi-1)].y; }
		if (mode==1) { document.getElementById(posInput).value = Rhos['0'][Nz*(yi-1)].y; }

		setViewerShape(plateId);
		setPlateMode(plateId, V_mode);

		plateMesh = canvas.getPlateMesh(plateId);
		plateMesh.geometry.elementsNeedUpdate = true;
	}

  }
	else
	{	
		
		
	}

	//setArrows(plateId);

}


function Sel_Draw_Eqv(mode)
{	
	
	if(mode===0)
	{
		scene.add( eqv_surf_b );
		scene.add( eqv_surf_f );

	}
	else if (mode===1)
	{
		scene.remove( eqv_surf_b );
		scene.remove( eqv_surf_f );

	}

}

function ON_MouseMove(){ document.addEventListener( 'mousemove', onDocumentMouseMove, false );}

function OFF_MouseMove(){ document.removeEventListener( 'mousemove', onDocumentMouseMove, false ); }

function ON_MouseMove_out()
{
	document.addEventListener( 'mousemove', onDocumentMouseMove, false );
}


function OFF_MouseMove_out()
{

	document.removeEventListener( 'mousemove', onDocumentMouseMove, false ); 
}



function onDocumentMouseOver( event )
{
	event.preventDefault();
	
}

function Search_data()
{
	document.getElementById("id_updateDB_state").style.color = "#000000";
	document.getElementById("id_updateDB_state").innerHTML  = "";

	clear_contents();

	F_m_graph = false;

	DB_search.form_submit();
}

function Download()
{
	document.getElementById("id_updateDB_state").style.color = "#000000";
	document.getElementById("id_updateDB_state").innerHTML  = "";

	DB_download.make_zip();
}


function Update_DBWeb(mod)
{

	if(mod==0)
	{
		document.getElementById("id_updateDB_state").style.color = "#ff0000";
		document.getElementById("id_updateDB_state").innerHTML   = "Updating DB ...";

		document.getElementById('id_hidden_selpath').value = "";		

		document.getElementById("id_updateDB_state2").style.color = "#000000";
		document.getElementById("id_updateDB_state2").innerHTML   = "";		


		DB_updateWeb{{time_string}}.form_submit(mod);

	}
	if(mod==1)
	{		

		document.getElementById("id_updateDB_state2").style.color = "#ff0000";
		document.getElementById("id_updateDB_state2").innerHTML   = "Updating DB ...";		

		document.getElementById("id_updateDB_state").style.color = "#000000";
		document.getElementById("id_updateDB_state").innerHTML   = "";

		DB_updateWeb2{{time_string}}.form_submit(mod);

	}
	
}


function Qsort(arr, size, left, right, index)
{		
	var idx;

    if ( left < right )
    {
        idx = sort_partition(arr, size, left, right, index);

        Qsort(arr, size, left   , idx - 1, index);
        Qsort(arr, size, idx + 1, right  , index);
    }

			//return 0;
}

/***** Partition *****/
function sort_partition(arr, size, left, right, index)
{
    var m, n;
    var pivot;

    m = left;
    n = right + 1;
    pivot = arr[m];

    while ( 1 )
    {
        while ( arr[++m] < pivot ) if ( m >= right ) break;		
        while ( arr[--n] > pivot ) if ( n <= left ) break;			
        if ( m >= n ) break; else arr_swap(arr, m, n, index);		
    }

    if ( n == left ) return n;    

    arr_swap(arr, left, n, index);
    return n;
}


/***** Swap *****/

function arr_swap(arr, idx1, idx2, index)
{
    var tmp;
    var idx_tmp;

    if ( arr != null )
    {
        tmp = arr[idx1];
        arr[idx1] = arr[idx2];
        arr[idx2] = tmp;

        idx_tmp = index[idx1];
        index[idx1] = index[idx2];
        index[idx2] = idx_tmp;
        
        //return 0;
    }
}

var panel_open_states = {"L0":true, "L1":true,"R0":true};

function on_webpage(id0, id1)
{
	document.getElementById(id0).style.display = "";
	document.getElementById(id1).style.display = "none";
}

function Toggle_m_graph()
{
	F_m_graph = !F_m_graph;	

	if (F_m_graph == false)
	{
		document.getElementById("id_contents_graph2D_4").innerHTML= "";
		return;
	}
	else
	{
		Draw_m_graph();
	}
}

function Draw_m_graph()
{	

	var id_Label_x = "id_DBth_" + String(g_col_xyz[0]);
	var id_Label_y = "id_DBth_" + String(g_col_xyz[1]);

	var Label_x    = document.getElementById(id_Label_x).innerHTML;	
	var Label_y    = document.getElementById(id_Label_y).innerHTML;
	
	var DBtable, rows ;
		DBtable = document.getElementById("id_DBtable");
		rows = DBtable.rows;

	var data_string;
	data_string  = "#NumField:1\n" ;
	data_string += "#LabelX:" + Label_x + ", LabelY: "+ Label_y+"\n" ;
	data_string += "#Field0: , NumPoints: "+ N_DBdata +"\n" ;	

	for(var i=0; i<N_DBdata; i++)
    {	

		var cells = rows[i+1].getElementsByTagName('td');

		
		data_string += cells[g_col_xyz[0]-1].innerHTML + ", " + cells[g_col_xyz[1]-1].innerHTML +"\n";

		
	

	}

	document.getElementById("id_contents_graph2D_4").style.display= "";
	Draw_oneDplot('id_contents_graph2D_4', data_string);

}

</script>        


    </head>
    <body onload ="Initialize('{{keys}}', '{{User_List}}', '{{Year_List}}', '{{Journal_List}}', '{{Model_List}}', '{{program_List}}', '{{F_mod}}', '{{Dir_list}}');">

		        <!-- Navigation-->
				<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom border-dark border-3 sticky-top" >				

					<div class="container px-4 px-lg-5">
						<a class="navbar-brand" href="#!">Materials database</a>
						<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
						<div class="collapse navbar-collapse" id="navbarSupportedContent" >
							<ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
								<li class="nav-item"><a class="nav-link" href="http://platinum.kaist.ac.kr">Home</a></li>							
								<li class="nav-item"><a class="nav-link" onclick="on_webpage('id_upload', 'id_Search_visualize')" style="cursor:pointer;">Upload</a></li>							
								<li class="nav-item"><a class="nav-link" onclick="on_webpage('id_Search_visualize', 'id_upload')" style="cursor:pointer;">Search</a></li>							
								<li class="nav-item"><a class="nav-link" href="#!">About</a></li>
							</ul>

							<ul class="navbar-nav me-right mb-2 mb-lg-0 ms-lg-4">
								<li class="nav-item"> <a class="nav-link" id="id_User">User : {{curr_User}}</a> </li>
							</ul>

							<form class="d-flex" action = "/Logout_DB" method = "POST">     
								<button class="btn btn-outline-dark" type="submit">
									<i class="bi-cart-fill me-0"></i>
									Logout
								</button>
							</form>
						</div>
					</div>
				</nav>

			<table id ="id_upload" style="border: 1px solid #000000; width:1800px; font-size: 10pt; " >

				<tr>
					<td colspan = '2' style="text-align: center;">
						<div class="p-2 mb-2 bg-secondary text-white fs-5 rounded-pill bg-opacity-50" style="width:1700px" >Data upload </div>
					</td>
				</tr>	
				<tr>
					<td>
						<table style="width:840px">
							<tr>
								<td style="vertical-align: top; text-align: center;"> <label style="width: 100%; background-color:#eeeeee; font-weight: bold; text-align: left;" > Keywords for the directory name</label><br>
									<table>
										<tr>
											<td style="text-align: left;">Year</td>
											<td>
												<input type="text" id = "id_Year"        style="width: 250px; font-size: 10pt;">
											</td>
										</tr>
										<tr>
											<td style="text-align: left;">Journal</td>
											<td>
												<input type="text" id = "id_Journal"  style="width: 250px; font-size: 10pt;">
											</td>
										</tr>															
										<tr>
											<td style="text-align: left;">Model</td>
											<td>
												<input type="text" id = "id_Model"      style="width: 250px; font-size: 10pt;">
											</td>
										</tr>															
										<tr>
											<td style="text-align: left;">Comment</td>
											<td><input type="text" id = "id_Comment"  style="width: 250px; font-size: 10pt;"></td>
										</tr>															
										<tr>
											<td style="text-align: left;">Argument output</td>
											<td><input type="text" id = "id_argout" value = "stdout.txt" style="width: 250px; font-size: 10pt;"></td>
										</tr>
									</table>

								</td>
								<td style="vertical-align: top; text-align: center;">

									<label style="width: 100%; background-color:#eeeeee; font-weight: bold; text-align: left;" > Upload data from a client</label><br>

									<iframe name="ifram_Dropzone" src='/static/temp_Dropzone{{time_string}}.html' width='200px' height='140px'> </iframe>														
									<iframe name="DB_updateWeb{{time_string}}" src='/static/temp_DB_updateWeb{{time_string}}.html' width='1px' height='1px' > </iframe>
									<button id = "id_update_button" style='width: 100px; height:100%' onclick = 'Update_DBWeb(0)'>Update DB</button>
									<br>
									<label id = "id_updateDB_state"> </label>
								</td>

							</tr>
							<tr>
								<td colspan = "3" nowrap style = "border: 1px solid black; border-collapse: collapse; text-align: left;">
									<label style="width: 100%; background-color:#eeeeee; font-weight: bold; text-align: left;" > Upload data in the server</label><br>
									<label style="font-weight: bold;text-align: left;"> User directory tree</label>
									<iframe name="DB_updateWeb2{{time_string}}" src='/static/temp_DB_updateWeb{{time_string}}.html' width='1px' height='1px' > </iframe>
									<button id = "id_update_button2" style='width: 130px; height:100%; ' onclick = 'Update_DBWeb(1)'>Upload to DB</button>
									<label id = "id_updateDB_state2"> </label>

								</td>													
							</tr>
							<tr>
								<td colspan = "3" style = "border: 1px solid black; border-collapse: collapse; ">
									<div id = "id_Path_Tree" style = "height:700px; overflow:auto"></div>
									
								</td>													
							</tr>
						</table>
						
					</td>
					<td style="vertical-align: top; text-align: center;">
						<label style="width: 100%; background-color:#eeeeee; font-weight: bold; text-align: left;" > User data list</label><br>
						<table id="id_dir_list" style="width:840px; text-align: left;" >

						</table>
					</td>
				</tr>	


			</table>

			<table id ="id_Search_visualize" style="border: 1px solid #000000; width:1800px; font-size: 10pt; display: none;" >
				<tr>
					<td colspan="3" style="text-align: center;">
						<div class="p-2 mb-2 bg-secondary text-white fs-5 rounded-pill" style="width:1750px" >Data search and analysis</div> 											
					</td>
				</tr>					
				<tr>
					<td style="vertical-align: top;">						
						<table style="height : 150px">
							<tr>
								<td style="text-align: center;">
									<label style="width: 100%; background-color:#eeeeee; font-weight: bold;" > Keyword search</label><br>
									<table style="text-align: left; ">
										<tr>
											<td> Field1 </td>
											<td>          
												
												<table id= "id_search_item_center" style="text-align: center;">
													<tr id="Field_tr1_center">                                  </tr>
													<tr id="Field_tr2_center">                                  </tr>							   
												</table>       
						
											</td>
											<td>
												<table style="text-align: center; ">
													<tr> <td> Formula search</td>                                 </tr>
													<tr> 
														<td> <input type = "text" value='' id= "id_search_text" size=30 />	</td>
													</tr>
												</table>       
												
											</td>																						
										</tr>
										<tr>
											<td>  Field2
											</td>
											<td>  
												<table id= "id_search_item_right" style="text-align: center;">
													<tr id="Field_tr1_right">                                 </tr>
													<tr id="Field_tr2_right">                                 </tr>							   
												</table> 
												
											</td>
											<td>
												<table>
													<tr>
														<td>
															<iframe name="DB_search" src='/static/temp_DB_search{{time_string}}.html' width='1px' height='1px' > </iframe>
															<button id = "id_search_button" value = "Search" style='width: 80px;' onclick = 'Search_data()'>Search</button>

															<iframe name="DB_download" src='/static/temp_DB_download{{time_string}}.html' width='1px' height='1px' > </iframe>
															<button style='width: 80px;' onclick = 'Download()'> Download</button>
	
															<!-- <a id ="id_download_result" href="" download> <button style='width: 80px;' >Download</button> </a>  -->
															
														</td>
	
													</tr>
													<tr>
														<td>
															<label id="id_N_DB"> </label> items found
														</td>													
													</tr>
												</table>

												
											</td>										
										</tr>					
									</table>
								</td>
							</tr>
							<tr>
								<td>									
									<table style="width:720px;">
										<tr>
											<td style="width:520px; text-align: center;">
												<label style="width: 100%; background-color:#eeeeee; font-weight: bold;" > Search results</label><br>
												<div id ='id_Wrapper_DBtable' style="width:520px; height:350px; overflow:auto; text-align: left;">             </div>
											</td>

											<td style="width:200px; vertical-align: top; text-align: center; font-weight: bold;">										
												<label style="width: 100%; background-color:#eeeeee;" > File list</label><br>	
												<select id = 'id_File_list' name='File_list' multiple style="width:195px; height:350px; font-size:12px;  font-weight: bold;" onclick="show_file_contents()">  </select>
											</td>

										</tr>								
									</table>
								</td>
							</tr>
						</table>

					</td>


					<td style="width: 540px; height:500px; vertical-align: top; font-weight: bold; text-align: center;">
						<label style="width: 100%; background-color:#eeeeee;" > Atomic structure</label><br>														
						<textarea id="id_contents_text_3" style="width:100%; height:95%; display:none;"> </textarea>
						<div id="id_contents_graph2D_3" style="width:100%; height:95%; display:none;" > </div>
						<div id="id_contents_graph3D_3" style="width:100%; height:95%; display:none;" > </div>
						
					</td>

					<td style="width: 540px; height:500px; vertical-align: top; font-weight: bold; text-align: center;">

						<div id="id_control_panel" style="width:300px; ">
					
							<table style="width:100%;"> 
								<tr>
									<td bgcolor='#ddddee' colspan="1">Atom information</td>
								</tr>
								<tr style="text-align: center; font-size: 10pt;" >
									<td><textarea id='id_text_atom_info' spellcheck = 'false' style='width:99%; height:110px;'> </textarea></td> 												
								</tr>					
							</table>														
		
							<table style="width:100%;"> 
								<tr bgcolor='#ddddee' > 
								<td > <SPAN style='font-size: 10pt'> Viewer </SPAN> </td>
								<td> <SPAN style='font-size: 10pt'> density </SPAN> </td>
								<td> <SPAN style='font-size: 10pt'> terrain </SPAN> </td>
								<td> <SPAN style='font-size: 10pt'> E field </SPAN> </td> 
								</tr>
								<tr> 
								<td > <SPAN style='font-size: 10pt'> Pxy </SPAN> </td>
								<td> <input id='Pxy_visible' type='checkbox' onclick="toggleView( 'xy' )"> </td>
								<td> <input id='Pxy_mode' type='checkbox' onclick="toggleTerrain('xy')"> </td> 
								<td> <input id='Pxy_arr_visible' type='checkbox' onclick="toggleArrows('xy')"> </td> 
								</tr>
								<tr>
								<td> <SPAN style='font-size: 10pt'> Pyz </SPAN> </td>
								<td> <input id='Pyz_visible' type='checkbox' onclick="toggleView( 'yz' )"> </td>
								<td> <input id='Pyz_mode' type='checkbox' onclick="toggleTerrain('yz')"> </td> 
								<td> <input id='Pyz_arr_visible' type='checkbox' onclick="toggleArrows('yz')"> </td> 
								</tr>
								<tr> 
								<td> <SPAN style='font-size: 10pt'> Pzx </SPAN> </td>
								<td> <input id='Pzx_visible' type='checkbox' onclick="toggleView( 'zx' )"> </td> 
								<td> <input id='Pzx_mode' type='checkbox' onclick="toggleTerrain('zx')"> </td> 
								<td> <input id='Pzx_arr_visible' type='checkbox' onclick="toggleArrows('zx')"> </td> 
								</tr> 
								</table> 
		
								<table style="width:95%;"> 
								<tr> 
								<td colspan='1'> <SPAN style='font-size: 10pt'> Viewer </SPAN> </td>
								<td colspan='2' bgcolor='#ddddee'> <SPAN style='font-size: 10pt'> position </SPAN></td>											
								</tr> 
								<tr> 
								<td colspan='1'> <SPAN style='font-size: 10pt'> Pxy </SPAN> </td>
								<td colspan='1'> <input id='PxyRange' type='range' style='width:90%;' value='1' min='1' max='1' step='1' oninput="movePlate('xy')" onmouseover="OFF_MouseMove_out()" onmouseleave="ON_MouseMove_out()" autocomplete='off'/> </td>
								<td> <input id='PxyInput1' type='text' value='0' size='3' height='1' autocomplete='off'> </td>	
								</tr> 
								<tr> 
								<td colspan='1'> <SPAN style='font-size: 10pt'> Pyz </SPAN> </td>
								<td colspan='1'> <input id='PyzRange' type='range' style='width:90%;' value='1' min='1' max='1' step='1' oninput="movePlate('yz')" onmouseover="OFF_MouseMove_out()" onmouseleave="ON_MouseMove_out()" autocomplete='off'/> </td>
								<td> <input id='PyzInput1' type='text' value='0' size='3' height='1' autocomplete='off'> </td>
								</tr>
								<tr> 
								<td colspan='1'> <SPAN style='font-size: 10pt'> Pzx </SPAN> </td>
								<td colspan='1'> <input id='PzxRange' type='range' style='width:90%;' value='1' min='1' max='1' step='1' oninput="movePlate('zx')" onmouseover="OFF_MouseMove_out()" onmouseleave="ON_MouseMove_out()" autocomplete='off'/> </td>
								<td> <input id='PzxInput1' type='text' value='0' size='3' height='1' autocomplete='off'> </td>
								</tr>
								</table>
		
								<table> 
									<tr style='font-size: 10pt'>										
										<td><input type='radio' id='Draw_V' name='Draw_VR' checked='checked' onclick="Sel_Draw_VR(0)"> Potential</td>
										<td><input type='radio' id='Draw_Rho' name='Draw_VR' onclick="Sel_Draw_VR(1)"> Charge density </td>									
									</tr>															
									<tr style="display: none;">
										<td colspan="2" style="text-align: center; "> Equivalue</td>
									</tr>
									<tr style='font-size: 10pt;display: none;'>										
										<td><input type='radio' id='Draw_Eqv_0' name='Draw_Eqv' onclick="Sel_Draw_Eqv(0)"> Yes </td>
										<td><input type='radio' id='Draw_Eqv_1' name='Draw_Eqv' checked='checked' onclick="Sel_Draw_Eqv(1)"> No </td>
									</tr>															
		
									<tr style="display: none;">
										<td><input id='MC_Range' type='range' style='width:90%' value='0.5' min='0' max='1' step='0.1' step='0.1' oninput="MC_effect(1)" onmouseover="OFF_MouseMove_out()" onmouseleave="ON_MouseMove_out()" autocomplete='off'/></td>
										<td> <input id='MC_Range_text' type='text' value='0.5' size='1' height='1' autocomplete='off'>  </td>									
									</tr>
								</table> 


						</div>								


						
					</td>						
				</tr>
				<tr>
					<td style="vertical-align: top;">
						<table style="width:720px;">
							<tr>

								<td style="width:720px; height:500px; vertical-align: top; text-align: center ; font-weight: bold;">
									<label style="width: 100%; background-color:#eeeeee;" > File info</label><br>
									<textarea id="id_contents_text_2" style="width:100%; height:99%; display:none;"> </textarea>
									<div id="id_contents_graph2D_2" style="width:100%; height:99%; display:none;" > </div>
									<div id="id_contents_graph3D_2" style="width:100%; height:99%; display:none;" > </div>

								</td>
							</tr>								
						</table>					


					</td>
					<td style="width:540px; height:500px; vertical-align: top; text-align: center; font-weight: bold;">			
					

						<label style="width: 100%; background-color:#eeeeee;" > Graph1</label><br>
						<textarea id="id_contents_text_1" style="width:100%; height:99%; display:none;"> </textarea>
						<div id="id_contents_graph2D_1" style="width:100%; height:99%; display:none;" > </div>
						<div id="id_contents_graph3D_1" style="width:100%; height:99%; display:none;" > </div>		
						
					</td>
					<td style="width:540px; height:500px; vertical-align: top; text-align: center; font-weight: bold;">						
						<label style="width: 100%; background-color:#eeeeee; cursor:pointer;" onclick="Toggle_m_graph()"> Graph for multiple points  </label> <br>						
						<textarea id="id_contents_text_4" style="width:100%; height:99%; display:none;"> </textarea>
						<div id="id_contents_graph2D_4" style="width:100%; height:99%; display:none;" > </div>
						<div id="id_contents_graph3D_4" style="width:100%; height:99%; display:none;" > </div>
						
					</td>						
				</tr>					
			</table>
        
        <input type = "text" id= "id_hidden_info" value="id_hidden_info" style="display:none;"  />   
		<input type = "text" id= "id_hidden_info_field" name="hidden_info_field" value="" style="display:none;"  />  
		<input type = "text" id= "id_hidden_selpath" value="" style="display:none;"  />  
		<input type = "text" id= "id_hidden_SelNewPath" value="" style="display:none;"  />  
		<input type = "text" id= "id_hidden_Download_link" value="" style="display:none;"  />		
		<textarea id="id_User_Paths" style="display:none;"> {{User_Paths}} </textarea>

        <!-- Footer-->
        <footer class="py-1 bg-dark">
            <div class="container"><p class="m-0 text-center text-white">Lab's name </p></div>
        </footer>
      
      
    </body>
</html>
